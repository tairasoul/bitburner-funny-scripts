import Multiport from "/general/multiport";
// Classes
class MessageQueue {
    port;
    constructor(ns, start, end) {
        this.port = new Multiport(ns, { start, end });
    }
    get requestAvailable() {
        return this.port.peek() != null;
    }
    async processRequest(reqProcessor) {
        const data = this.port.read();
        const parsed = JSON.parse(data);
        await reqProcessor(parsed);
    }
}
class PortHandler {
    ns;
    requests;
    responses;
    assigned = [];
    constructor(ns) {
        this.ns = ns;
        this.requests = new MessageQueue(ns, 1, 100);
        this.responses = new Multiport(ns, { start: 101, end: 200 });
    }
    async startHandling() {
        while (true) {
            await this.ns.sleep(1);
            if (this.requests.requestAvailable) {
                await this.requests.processRequest(async (message) => await this.handleRequest(message));
            }
        }
    }
    async handleRequest(message) {
        switch (message.request) {
            case "assign":
                if (this.arePortsUnassigned(message.ports)) {
                    this.assigned.push({
                        pid: message.pid,
                        ports: message.ports
                    });
                    this.sendResponse({
                        pid: message.pid,
                        result: "assigned"
                    });
                }
                else {
                    const owners = [];
                    for (const port of message.ports) {
                        const owner = this.getOwnerOf(port);
                        if (owner) {
                            owners.push(owner);
                        }
                    }
                    this.sendResponse({
                        pid: message.pid,
                        result: "couldnt assign",
                        owned_by: owners
                    });
                }
                break;
            case "unassign":
                const found = this.assigned.find((v) => {
                    let portsMatch = true;
                    message.ports.forEach((val) => {
                        if (!v.ports.includes(val)) {
                            portsMatch = false;
                        }
                    });
                    return portsMatch;
                });
                for (const port of message.ports) {
                    this.ns.getPortHandle(port).clear();
                }
                if (found) {
                    this.assigned = this.assigned.filter((v) => v != found);
                }
                break;
            case "assignAvailable":
                const availablePorts = [];
                let availableFound = 0;
                for (let i = 10001; i < 200000; i++) {
                    if (this.isPortUnassigned(i)) {
                        availablePorts.push(i);
                        availableFound++;
                    }
                    if (availableFound >= message.portAmount)
                        break;
                }
                this.assigned.push({
                    pid: message.pid,
                    ports: availablePorts
                });
                this.sendResponse({
                    result: "assignedAvailable",
                    pid: message.pid,
                    assignedPorts: availablePorts
                });
        }
    }
    getOwnerOf(port) {
        for (const assigned of this.assigned) {
            if (assigned.ports.includes(port))
                return assigned.pid;
        }
        return;
    }
    isPortUnassigned(port) {
        for (const assigned of this.assigned) {
            if (assigned.ports.includes(port)) {
                return false;
            }
        }
        return true;
    }
    getUnassignedPortsFromList(ports) {
        const unassigned = [];
        for (const port of ports) {
            if (this.isPortUnassigned(port))
                unassigned.push(port);
        }
        return unassigned;
    }
    arePortsUnassigned(ports) {
        for (const port of ports) {
            if (!this.isPortUnassigned(port))
                return false;
        }
        return true;
    }
    sendResponse(response) {
        this.responses.writeEmpty(JSON.stringify(response));
    }
}
// Main code
export async function main(ns) {
    ns.disableLog("ALL");
    const handler = new PortHandler(ns);
    await handler.startHandling();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9ydC1yZWdpc3RyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9wb3J0LXJlZ2lzdHJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sU0FBUyxNQUFNLG9CQUFvQixDQUFDO0FBc0MzQyxVQUFVO0FBRVYsTUFBTSxZQUFZO0lBQ2QsSUFBSSxDQUFZO0lBQ2hCLFlBQVksRUFBUyxFQUFFLEtBQWEsRUFBRSxHQUFXO1FBQzdDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUMsS0FBSyxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVELElBQUksZ0JBQWdCO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxJQUFJLENBQUE7SUFDbkMsQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQUMsWUFBdUQ7UUFDeEUsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM5QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBbUIsQ0FBQztRQUNsRCxNQUFNLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMvQixDQUFDO0NBQ0o7QUFFRCxNQUFNLFdBQVc7SUFDTCxFQUFFLENBQVE7SUFDVixRQUFRLENBQWU7SUFDdkIsU0FBUyxDQUFZO0lBQ3JCLFFBQVEsR0FBZSxFQUFFLENBQUM7SUFDbEMsWUFBWSxFQUFTO1FBQ2pCLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFlBQVksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUMsS0FBSyxFQUFFLEdBQUcs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LFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDN0I7UUFDRCxPQUFPLFVBQVUsQ0FBQztJQUN0QixDQUFDO0lBRUQsa0JBQWtCLENBQUMsS0FBZTtRQUM5QixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtZQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQztnQkFDNUIsT0FBTyxLQUFLLENBQUM7U0FDcEI7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsWUFBWSxDQUFDLFFBQXlCO1FBQ2xDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUN4RCxDQUFDO0NBQ0o7QUFFRCxZQUFZO0FBRVosTUFBTSxDQUFDLEtBQUssVUFBVSxJQUFJLENBQUMsRUFBUztJQUNoQyxFQUFFLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ3BCLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sT0FBTyxDQUFDLGFBQWEsRUFBRSxDQUFDO0FBQ2xDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbnMgZnJvbSBcIkBuc1wiO1xuaW1wb3J0IE11bHRpcG9ydCBmcm9tIFwiL2dlbmVyYWwvbXVsdGlwb3J0XCI7XG5pbXBvcnQgTG9ja2ZpbGUgZnJvbSBcIi9nZW5lcmFsL2xvY2tzXCI7XG5cbi8vIFR5cGVzXG5cbnR5cGUgQXNzaWduZWQgPSB7XG4gICAgcGlkOiBudW1iZXI7XG4gICAgcG9ydHM6IG51bWJlcltdO1xufVxuXG5leHBvcnQgdHlwZSBSZXNwb25zZU1lc3NhZ2UgPSB7XG4gICAgcGlkOiBudW1iZXI7XG4gICAgcmVzdWx0OiBcImFzc2lnbmVkXCJcbn0gfCB7XG4gICAgcGlkOiBudW1iZXI7XG4gICAgcmVzdWx0OiBcImNvdWxkbnQgYXNzaWduXCI7XG4gICAgb3duZWRfYnk6IG51bWJlcltdO1xufSB8IHtcbiAgICBwaWQ6IG51bWJlcjtcbiAgICByZXN1bHQ6IFwiYXNzaWduZWRBdmFpbGFibGVcIjtcbiAgICBhc3NpZ25lZFBvcnRzOiBudW1iZXJbXTtcbn1cblxuXG5leHBvcnQgdHlwZSBIYW5kbGVyTWVzc2FnZSA9IHtcbiAgICByZXF1ZXN0OiBcImFzc2lnblwiO1xuICAgIHBvcnRzOiBudW1iZXJbXTtcbiAgICBwaWQ6IG51bWJlcjtcbn0gfCB7XG4gICAgcmVxdWVzdDogXCJ1bmFzc2lnblwiO1xuICAgIHBvcnRzOiBudW1iZXJbXTtcbiAgICBwaWQ6IG51bWJlcjtcbn0gfCB7XG4gICAgcmVxdWVzdDogXCJhc3NpZ25BdmFpbGFibGVcIjtcbiAgICBwb3J0QW1vdW50OiBudW1iZXI7XG4gICAgcGlkOiBudW1iZXI7XG59XG5cbi8vIENsYXNzZXNcblxuY2xhc3MgTWVzc2FnZVF1ZXVlIHtcbiAgICBwb3J0OiBNdWx0aXBvcnQ7XG4gICAgY29uc3RydWN0b3IobnM6IG5zLk5TLCBzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlcikge1xuICAgICAgICB0aGlzLnBvcnQgPSBuZXcgTXVsdGlwb3J0KG5zLCB7c3RhcnQsIGVuZH0pO1xuICAgIH1cblxuICAgIGdldCByZXF1ZXN0QXZhaWxhYmxlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3J0LnBlZWsoKSAhPSBudWxsXG4gICAgfVxuXG4gICAgYXN5bmMgcHJvY2Vzc1JlcXVlc3QocmVxUHJvY2Vzc29yOiAobWVzc2FnZTogSGFuZGxlck1lc3NhZ2UpID0+IFByb21pc2U8YW55Pikge1xuICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5wb3J0LnJlYWQoKTtcbiAgICAgICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShkYXRhKSBhcyBIYW5kbGVyTWVzc2FnZTtcbiAgICAgICAgYXdhaXQgcmVxUHJvY2Vzc29yKHBhcnNlZCk7XG4gICAgfVxufVxuXG5jbGFzcyBQb3J0SGFuZGxlciB7XG4gICAgcHJpdmF0ZSBuczogbnMuTlM7XG4gICAgcHJpdmF0ZSByZXF1ZXN0czogTWVzc2FnZVF1ZXVlO1xuICAgIHByaXZhdGUgcmVzcG9uc2VzOiBNdWx0aXBvcnQ7XG4gICAgcHJpdmF0ZSBhc3NpZ25lZDogQXNzaWduZWRbXSA9IFtdO1xuICAgIGNvbnN0cnVjdG9yKG5zOiBucy5OUykge1xuICAgICAgICB0aGlzLm5zID0gbnM7XG4gICAgICAgIHRoaXMucmVxdWVzdHMgPSBuZXcgTWVzc2FnZVF1ZXVlKG5zLCAxLCAxMDApO1xuICAgICAgICB0aGlzLnJlc3BvbnNlcyA9IG5ldyBNdWx0aXBvcnQobnMsIHtzdGFydDogMTAxLCBlbmQ6IDIwMH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHN0YXJ0SGFuZGxpbmcoKSB7XG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLm5zLnNsZWVwKDEpO1xuICAgICAgICAgICAgaWYgKHRoaXMucmVxdWVzdHMucmVxdWVzdEF2YWlsYWJsZSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucmVxdWVzdHMucHJvY2Vzc1JlcXVlc3QoYXN5bmMgKG1lc3NhZ2UpID0+IGF3YWl0IHRoaXMuaGFuZGxlUmVxdWVzdChtZXNzYWdlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBoYW5kbGVSZXF1ZXN0KG1lc3NhZ2U6IEhhbmRsZXJNZXNzYWdlKSB7XG4gICAgICAgIHN3aXRjaCAobWVzc2FnZS5yZXF1ZXN0KSB7XG4gICAgICAgICAgICBjYXNlIFwiYXNzaWduXCI6XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYXJlUG9ydHNVbmFzc2lnbmVkKG1lc3NhZ2UucG9ydHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXNzaWduZWQucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWQ6IG1lc3NhZ2UucGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcnRzOiBtZXNzYWdlLnBvcnRzXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVzcG9uc2UoXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGlkOiBtZXNzYWdlLnBpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IFwiYXNzaWduZWRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvd25lcnM6IG51bWJlcltdID0gW107XG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcG9ydCBvZiBtZXNzYWdlLnBvcnRzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvd25lciA9IHRoaXMuZ2V0T3duZXJPZihwb3J0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvd25lcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG93bmVycy5wdXNoKG93bmVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbmRSZXNwb25zZShcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWQ6IG1lc3NhZ2UucGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogXCJjb3VsZG50IGFzc2lnblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG93bmVkX2J5OiBvd25lcnNcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJ1bmFzc2lnblwiOlxuICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gdGhpcy5hc3NpZ25lZC5maW5kKCh2KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBwb3J0c01hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5wb3J0cy5mb3JFYWNoKCh2YWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdi5wb3J0cy5pbmNsdWRlcyh2YWwpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9ydHNNYXRjaCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcG9ydHNNYXRjaDtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcG9ydCBvZiBtZXNzYWdlLnBvcnRzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubnMuZ2V0UG9ydEhhbmRsZShwb3J0KS5jbGVhcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZm91bmQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hc3NpZ25lZCA9IHRoaXMuYXNzaWduZWQuZmlsdGVyKCh2KSA9PiB2ICE9IGZvdW5kKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiYXNzaWduQXZhaWxhYmxlXCI6XG4gICAgICAgICAgICAgICAgY29uc3QgYXZhaWxhYmxlUG9ydHM6IG51bWJlcltdID0gW107XG4gICAgICAgICAgICAgICAgbGV0IGF2YWlsYWJsZUZvdW5kID0gMDtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMTAwMDE7IGkgPCAyMDAwMDA7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1BvcnRVbmFzc2lnbmVkKGkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGVQb3J0cy5wdXNoKGkpXG4gICAgICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGVGb3VuZCsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChhdmFpbGFibGVGb3VuZCA+PSBtZXNzYWdlLnBvcnRBbW91bnQpXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5hc3NpZ25lZC5wdXNoKFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwaWQ6IG1lc3NhZ2UucGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgcG9ydHM6IGF2YWlsYWJsZVBvcnRzXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVzcG9uc2UoXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogXCJhc3NpZ25lZEF2YWlsYWJsZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGlkOiBtZXNzYWdlLnBpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lnbmVkUG9ydHM6IGF2YWlsYWJsZVBvcnRzXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRPd25lck9mKHBvcnQ6IG51bWJlcikge1xuICAgICAgICBmb3IgKGNvbnN0IGFzc2lnbmVkIG9mIHRoaXMuYXNzaWduZWQpIHtcbiAgICAgICAgICAgIGlmIChhc3NpZ25lZC5wb3J0cy5pbmNsdWRlcyhwb3J0KSlcbiAgICAgICAgICAgICAgICByZXR1cm4gYXNzaWduZWQucGlkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpc1BvcnRVbmFzc2lnbmVkKHBvcnQ6IG51bWJlcikge1xuICAgICAgICBmb3IgKGNvbnN0IGFzc2lnbmVkIG9mIHRoaXMuYXNzaWduZWQpIHtcbiAgICAgICAgICAgIGlmIChhc3NpZ25lZC5wb3J0cy5pbmNsdWRlcyhwb3J0KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBnZXRVbmFzc2lnbmVkUG9ydHNGcm9tTGlzdChwb3J0czogbnVtYmVyW10pIHtcbiAgICAgICAgY29uc3QgdW5hc3NpZ25lZDogbnVtYmVyW10gPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBwb3J0IG9mIHBvcnRzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pc1BvcnRVbmFzc2lnbmVkKHBvcnQpKVxuICAgICAgICAgICAgICAgIHVuYXNzaWduZWQucHVzaChwb3J0KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5hc3NpZ25lZDtcbiAgICB9XG5cbiAgICBhcmVQb3J0c1VuYXNzaWduZWQocG9ydHM6IG51bWJlcltdKSB7XG4gICAgICAgIGZvciAoY29uc3QgcG9ydCBvZiBwb3J0cykge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmlzUG9ydFVuYXNzaWduZWQocG9ydCkpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHNlbmRSZXNwb25zZShyZXNwb25zZTogUmVzcG9uc2VNZXNzYWdlKSB7XG4gICAgICAgIHRoaXMucmVzcG9uc2VzLndyaXRlRW1wdHkoSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICB9XG59XG5cbi8vIE1haW4gY29kZVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbWFpbihuczogbnMuTlMpIHtcbiAgICBucy5kaXNhYmxlTG9nKFwiQUxMXCIpXG4gICAgY29uc3QgaGFuZGxlciA9IG5ldyBQb3J0SGFuZGxlcihucyk7XG4gICAgYXdhaXQgaGFuZGxlci5zdGFydEhhbmRsaW5nKCk7XG59Il19