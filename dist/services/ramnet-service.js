import RamNet from "/general/ramnet";
import Multiport from "/general/multiport";
import Logs from "/general/logs";
import Lockfile from "/general/locks";
class RamnetService {
    #ns;
    #requests;
    #responses;
    ramnet;
    #logs;
    constructor(ns, requests, responses) {
        this.#ns = ns;
        this.#requests = requests;
        this.#responses = responses;
        this.ramnet = new RamNet(ns);
        this.#logs = new Logs(ns, "Ramnet-Service");
    }
    async handleRequests() {
        while (true) {
            await this.#ns.sleep(1);
            if (!this.#requests.empty()) {
                await this.handleMessage(JSON.parse(this.#requests.read()));
            }
        }
    }
    async handleMessage(message) {
        await this.#logs.Log(`Handling message of type ${message.message}.`);
        switch (message.message) {
            case "get":
                switch (message.value) {
                    case "totalRam":
                        this.#responses.writeEmpty({
                            pid: message.pid,
                            totalRam: this.ramnet.totalRam
                        });
                        break;
                    case "maxRam":
                        this.#responses.writeEmpty({
                            pid: message.pid,
                            maxRam: this.ramnet.maxRam
                        });
                        break;
                    case "maxBlockSize":
                        this.#responses.writeEmpty({
                            pid: message.pid,
                            maxBlockSize: this.ramnet.maxBlockSize
                        });
                        break;
                    case "clone":
                        this.#responses.writeEmpty({
                            pid: message.pid,
                            clone: this.ramnet.clone
                        });
                        break;
                }
                break;
            case "assign":
                this.ramnet.assign(message.job);
                this.#responses.writeEmpty({
                    pid: message.pid,
                    result: "assignedJob",
                    jobAssigned: message.job
                });
                break;
            case "finish":
                this.ramnet.finish(message.job);
                this.#responses.writeEmpty({
                    pid: message.pid,
                    result: "finishedJob",
                    jobFinished: message.job
                });
                break;
            case "getBlock":
                this.#responses.writeEmpty({
                    pid: message.pid,
                    block: this.ramnet.getBlock(message.block)
                });
                break;
            case "hasBlock":
                this.#responses.writeEmpty({
                    pid: message.pid,
                    result: this.ramnet.hasBlock(message.block)
                });
                break;
            case "updateRamnet":
                await this.ramnet.update();
                break;
        }
    }
}
export async function main(ns) {
    ns.disableLog("ALL");
    const lockfile = new Lockfile(ns);
    if (!lockfile.isLocked("ramnet-service")) {
        await lockfile.lock('ramnet-service');
        ns.atExit(() => {
            lockfile.unlock("ramnet-service");
        });
        const requests = new Multiport(ns, { start: 201, end: 300 });
        const responses = new Multiport(ns, { start: 301, end: 400 });
        const service = new RamnetService(ns, requests, responses);
        await service.ramnet.init();
        await service.handleRequests();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFtbmV0LXNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmljZXMvcmFtbmV0LXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxNQUFzQixNQUFNLGlCQUFpQixDQUFDO0FBQ3JELE9BQU8sU0FBUyxNQUFNLG9CQUFvQixDQUFDO0FBQzNDLE9BQU8sSUFBSSxNQUFNLGVBQWUsQ0FBQztBQUNqQyxPQUFPLFFBQVEsTUFBTSxnQkFBZ0IsQ0FBQztBQTZFdEMsTUFBTSxhQUFhO0lBQ2YsR0FBRyxDQUFPO0lBQ1YsU0FBUyxDQUFZO0lBQ3JCLFVBQVUsQ0FBWTtJQUN0QixNQUFNLENBQVM7SUFDZixLQUFLLENBQU87SUFDWixZQUFZLEVBQVMsRUFBRSxRQUFtQixFQUFFLFNBQW9CO1FBQzVELElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUM7UUFDMUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYztRQUNoQixPQUFPLElBQUksRUFBRTtZQUNULE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUU7Z0JBQ3pCLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQy9EO1NBQ0o7SUFDTCxDQUFDO0lB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QUM7SUFDckIsTUFBTSxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDakMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtRQUN0QyxNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN0QyxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRTtZQUNYLFFBQVEsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN0QyxDQUFDLENBQUMsQ0FBQTtRQUNGLE1BQU0sUUFBUSxHQUFHLElBQUksU0FBUyxDQUFDLEVBQUUsRUFBRSxFQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUM7UUFDM0QsTUFBTSxTQUFTLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQztRQUM1RCxNQUFNLE9BQU8sR0FBRyxJQUFJLGFBQWEsQ0FBQyxFQUFFLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQzNELE1BQU0sT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM1QixNQUFNLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQztLQUNsQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbnMgZnJvbSBcIkBuc1wiO1xuaW1wb3J0IFJhbU5ldCwgeyBCbG9jaywgSm9iIH0gZnJvbSBcIi9nZW5lcmFsL3JhbW5ldFwiO1xuaW1wb3J0IE11bHRpcG9ydCBmcm9tIFwiL2dlbmVyYWwvbXVsdGlwb3J0XCI7XG5pbXBvcnQgTG9ncyBmcm9tIFwiL2dlbmVyYWwvbG9nc1wiO1xuaW1wb3J0IExvY2tmaWxlIGZyb20gXCIvZ2VuZXJhbC9sb2Nrc1wiO1xuXG5leHBvcnQgdHlwZSBSYW1uZXRNZXNzYWdlID0ge1xuICAgIHBpZDogbnVtYmVyO1xuICAgIG1lc3NhZ2U6IFwiZ2V0XCIsXG4gICAgdmFsdWU6IFwidG90YWxSYW1cIiB8IFwibWF4UmFtXCIgfCBcIm1heEJsb2NrU2l6ZVwiIHwgXCJjbG9uZVwiO1xufSB8IHtcbiAgICBwaWQ6IG51bWJlcjtcbiAgICBtZXNzYWdlOiBcImFzc2lnblwiO1xuICAgIGpvYjogSm9iO1xufSB8IHtcbiAgICBwaWQ6IG51bWJlcjtcbiAgICBtZXNzYWdlOiBcImZpbmlzaFwiO1xuICAgIGpvYjogSm9iO1xufSB8IHtcbiAgICBwaWQ6IG51bWJlcjtcbiAgICBtZXNzYWdlOiBcImdldEJsb2NrXCI7XG4gICAgYmxvY2s6IHN0cmluZztcbn0gfCB7XG4gICAgcGlkOiBudW1iZXI7XG4gICAgbWVzc2FnZTogXCJoYXNCbG9ja1wiO1xuICAgIGJsb2NrOiBzdHJpbmc7XG59IHwge1xuICAgIG1lc3NhZ2U6IFwidXBkYXRlUmFtbmV0XCI7XG59XG5cbmV4cG9ydCB0eXBlIFJhbW5ldFJlc3BvbnNlID0gdG90YWxSYW1SZXN1bHRcbiAgICB8IG1heFJhbVJlc3VsdFxuICAgIHwgbWF4QmxvY2tTaXplUmVzdWx0XG4gICAgfCBjbG9uZVJlc3VsdFxuICAgIHwgYXNzaWduSm9iUmVzdWx0XG4gICAgfCBmaW5pc2hKb2JSZXN1bHRcbiAgICB8IGdldEJsb2NrUmVzdWx0XG4gICAgfCBoYXNCbG9ja1Jlc3VsdDtcblxuZXhwb3J0IHR5cGUgdG90YWxSYW1SZXN1bHQgPSB7XG4gICAgcGlkOiBudW1iZXI7XG4gICAgdG90YWxSYW06IG51bWJlcjtcbn1cblxuZXhwb3J0IHR5cGUgbWF4UmFtUmVzdWx0ID0ge1xuICAgIHBpZDogbnVtYmVyO1xuICAgIG1heFJhbTogbnVtYmVyO1xufVxuXG5leHBvcnQgdHlwZSBtYXhCbG9ja1NpemVSZXN1bHQgPSB7XG4gICAgcGlkOiBudW1iZXI7XG4gICAgbWF4QmxvY2tTaXplOiBudW1iZXI7XG59XG5cbmV4cG9ydCB0eXBlIGNsb25lUmVzdWx0ID0ge1xuICAgIHBpZDogbnVtYmVyO1xuICAgIGNsb25lOiBCbG9ja1tdO1xufVxuXG5leHBvcnQgdHlwZSBhc3NpZ25Kb2JSZXN1bHQgPSB7XG4gICAgcGlkOiBudW1iZXI7XG4gICAgcmVzdWx0OiBcImFzc2lnbmVkSm9iXCI7XG4gICAgam9iQXNzaWduZWQ6IEpvYjtcbn0gXG5cbmV4cG9ydCB0eXBlIGZpbmlzaEpvYlJlc3VsdCA9IHtcbiAgICBwaWQ6IG51bWJlcjtcbiAgICByZXN1bHQ6IFwiZmluaXNoZWRKb2JcIjtcbiAgICBqb2JGaW5pc2hlZDogSm9iO1xufVxuXG5leHBvcnQgdHlwZSBnZXRCbG9ja1Jlc3VsdCA9IHtcbiAgICBwaWQ6IG51bWJlcjtcbiAgICBibG9jazogQmxvY2s7XG59XG5cbmV4cG9ydCB0eXBlIGhhc0Jsb2NrUmVzdWx0ID0ge1xuICAgIHBpZDogbnVtYmVyO1xuICAgIHJlc3VsdDogYm9vbGVhbjtcbn1cblxuY2xhc3MgUmFtbmV0U2VydmljZSB7XG4gICAgI25zOiBucy5OU1xuICAgICNyZXF1ZXN0czogTXVsdGlwb3J0O1xuICAgICNyZXNwb25zZXM6IE11bHRpcG9ydDtcbiAgICByYW1uZXQ6IFJhbU5ldDtcbiAgICAjbG9nczogTG9ncztcbiAgICBjb25zdHJ1Y3RvcihuczogbnMuTlMsIHJlcXVlc3RzOiBNdWx0aXBvcnQsIHJlc3BvbnNlczogTXVsdGlwb3J0KSB7XG4gICAgICAgIHRoaXMuI25zID0gbnM7XG4gICAgICAgIHRoaXMuI3JlcXVlc3RzID0gcmVxdWVzdHM7XG4gICAgICAgIHRoaXMuI3Jlc3BvbnNlcyA9IHJlc3BvbnNlcztcbiAgICAgICAgdGhpcy5yYW1uZXQgPSBuZXcgUmFtTmV0KG5zKTtcbiAgICAgICAgdGhpcy4jbG9ncyA9IG5ldyBMb2dzKG5zLCBcIlJhbW5ldC1TZXJ2aWNlXCIpO1xuICAgIH1cblxuICAgIGFzeW5jIGhhbmRsZVJlcXVlc3RzKCkge1xuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy4jbnMuc2xlZXAoMSk7XG4gICAgICAgICAgICBpZiAoIXRoaXMuI3JlcXVlc3RzLmVtcHR5KCkpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZU1lc3NhZ2UoSlNPTi5wYXJzZSh0aGlzLiNyZXF1ZXN0cy5yZWFkKCkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGhhbmRsZU1lc3NhZ2UobWVzc2FnZTogUmFtbmV0TWVzc2FnZSkge1xuICAgICAgICBhd2FpdCB0aGlzLiNsb2dzLkxvZyhgSGFuZGxpbmcgbWVzc2FnZSBvZiB0eXBlICR7bWVzc2FnZS5tZXNzYWdlfS5gKTtcbiAgICAgICAgc3dpdGNoKG1lc3NhZ2UubWVzc2FnZSkge1xuICAgICAgICAgICAgY2FzZSBcImdldFwiOlxuICAgICAgICAgICAgICAgIHN3aXRjaChtZXNzYWdlLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgXCJ0b3RhbFJhbVwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4jcmVzcG9uc2VzLndyaXRlRW1wdHkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWQ6IG1lc3NhZ2UucGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbFJhbTogdGhpcy5yYW1uZXQudG90YWxSYW1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1heFJhbVwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4jcmVzcG9uc2VzLndyaXRlRW1wdHkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWQ6IG1lc3NhZ2UucGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhSYW06IHRoaXMucmFtbmV0Lm1heFJhbVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIFwibWF4QmxvY2tTaXplXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiNyZXNwb25zZXMud3JpdGVFbXB0eShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZDogbWVzc2FnZS5waWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEJsb2NrU2l6ZTogdGhpcy5yYW1uZXQubWF4QmxvY2tTaXplXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgXCJjbG9uZVwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4jcmVzcG9uc2VzLndyaXRlRW1wdHkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWQ6IG1lc3NhZ2UucGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9uZTogdGhpcy5yYW1uZXQuY2xvbmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiYXNzaWduXCI6XG4gICAgICAgICAgICAgICAgdGhpcy5yYW1uZXQuYXNzaWduKG1lc3NhZ2Uuam9iKTtcbiAgICAgICAgICAgICAgICB0aGlzLiNyZXNwb25zZXMud3JpdGVFbXB0eShcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGlkOiBtZXNzYWdlLnBpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogXCJhc3NpZ25lZEpvYlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgam9iQXNzaWduZWQ6IG1lc3NhZ2Uuam9iXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiZmluaXNoXCI6XG4gICAgICAgICAgICAgICAgdGhpcy5yYW1uZXQuZmluaXNoKG1lc3NhZ2Uuam9iKTtcbiAgICAgICAgICAgICAgICB0aGlzLiNyZXNwb25zZXMud3JpdGVFbXB0eShcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGlkOiBtZXNzYWdlLnBpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDogXCJmaW5pc2hlZEpvYlwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgam9iRmluaXNoZWQ6IG1lc3NhZ2Uuam9iXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiZ2V0QmxvY2tcIjpcbiAgICAgICAgICAgICAgICB0aGlzLiNyZXNwb25zZXMud3JpdGVFbXB0eShcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGlkOiBtZXNzYWdlLnBpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrOiB0aGlzLnJhbW5ldC5nZXRCbG9jayhtZXNzYWdlLmJsb2NrKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcImhhc0Jsb2NrXCI6XG4gICAgICAgICAgICAgICAgdGhpcy4jcmVzcG9uc2VzLndyaXRlRW1wdHkoXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpZDogbWVzc2FnZS5waWQsXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ6IHRoaXMucmFtbmV0Lmhhc0Jsb2NrKG1lc3NhZ2UuYmxvY2spXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwidXBkYXRlUmFtbmV0XCI6XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5yYW1uZXQudXBkYXRlKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYWluKG5zOiBucy5OUykge1xuICAgIG5zLmRpc2FibGVMb2coXCJBTExcIik7XG4gICAgY29uc3QgbG9ja2ZpbGUgPSBuZXcgTG9ja2ZpbGUobnMpXG4gICAgaWYgKCFsb2NrZmlsZS5pc0xvY2tlZChcInJhbW5ldC1zZXJ2aWNlXCIpKSB7XG4gICAgICAgIGF3YWl0IGxvY2tmaWxlLmxvY2soJ3JhbW5ldC1zZXJ2aWNlJyk7XG4gICAgICAgIG5zLmF0RXhpdCgoKSA9PiB7XG4gICAgICAgICAgICBsb2NrZmlsZS51bmxvY2soXCJyYW1uZXQtc2VydmljZVwiKTtcbiAgICAgICAgfSlcbiAgICAgICAgY29uc3QgcmVxdWVzdHMgPSBuZXcgTXVsdGlwb3J0KG5zLCB7c3RhcnQ6IDIwMSwgZW5kOiAzMDB9KTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2VzID0gbmV3IE11bHRpcG9ydChucywge3N0YXJ0OiAzMDEsIGVuZDogNDAwfSk7XG4gICAgICAgIGNvbnN0IHNlcnZpY2UgPSBuZXcgUmFtbmV0U2VydmljZShucywgcmVxdWVzdHMsIHJlc3BvbnNlcyk7XG4gICAgICAgIGF3YWl0IHNlcnZpY2UucmFtbmV0LmluaXQoKTtcbiAgICAgICAgYXdhaXQgc2VydmljZS5oYW5kbGVSZXF1ZXN0cygpO1xuICAgIH1cbn0iXX0=