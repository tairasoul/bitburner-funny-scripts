import { list_servers, gainAccess } from "/general/utils";
export default class RamNet {
    #blocks = [];
    #minBlockSize = Infinity;
    #maxBlockSize = 0;
    #totalRam = 0;
    #maxRam = 0;
    #index = new Map();
    #ns;
    constructor(ns) {
        this.#ns = ns;
    }
    async init() {
        for (const server of list_servers(this.#ns)) {
            if (server != "Controller-Central") {
                if (!this.#ns.hasRootAccess(server)) {
                    await gainAccess(this.#ns, server);
                }
                if (this.#ns.hasRootAccess(server)) {
                    const maxRam = this.#ns.getServerMaxRam(server);
                    const ram = maxRam - this.#ns.getServerUsedRam(server);
                    if (ram >= 1.60) {
                        const block = { server: server, ram: ram };
                        this.#blocks.push(block);
                        if (ram < this.#minBlockSize)
                            this.#minBlockSize = ram;
                        if (ram > this.#maxBlockSize)
                            this.#maxBlockSize = ram;
                        this.#totalRam += ram;
                        this.#maxRam += maxRam;
                    }
                }
            }
        }
        this.#sort();
        this.#blocks.forEach((block, index) => this.#index.set(block.server, index));
    }
    async update() {
        this.#blocks = [];
        this.#totalRam += 0;
        this.#maxRam += 0;
        for (const server of list_servers(this.#ns)) {
            if (server != "Controller-Central") {
                if (!this.#ns.hasRootAccess(server)) {
                    await gainAccess(this.#ns, server);
                }
                if (this.#ns.hasRootAccess(server)) {
                    const maxRam = this.#ns.getServerMaxRam(server);
                    const ram = maxRam - this.#ns.getServerUsedRam(server);
                    if (ram >= 1.60) {
                        const block = { server: server, ram: ram };
                        this.#blocks.push(block);
                        if (ram < this.#minBlockSize)
                            this.#minBlockSize = ram;
                        if (ram > this.#maxBlockSize)
                            this.#maxBlockSize = ram;
                        this.#totalRam += ram;
                        this.#maxRam += maxRam;
                    }
                }
            }
        }
        this.#sort();
        this.#blocks.forEach((block, index) => this.#index.set(block.server, index));
    }
    #sort() {
        this.#blocks.sort((x, y) => {
            // Prefer assigning to home last so that we have more room to play the game while batching.
            if (x.server === "home")
                return 1;
            if (y.server === "home")
                return -1;
            return x.ram - y.ram;
        });
    }
    getBlock(server) {
        if (this.#index.has(server)) {
            return this.#blocks[this.#index.get(server)];
        }
        else {
            throw new Error(`Server ${server} not found in RamNet.`);
        }
    }
    hasBlock(server) {
        return this.#index.has(server);
    }
    get totalRam() {
        return this.#totalRam;
    }
    get maxRam() {
        return this.#maxRam;
    }
    get maxBlockSize() {
        return this.#maxBlockSize;
    }
    get clone() {
        return this.#blocks.map(block => ({ ...block }));
    }
    assign(job) {
        const block = this.#blocks.find(block => block.ram >= job.ram);
        if (!block)
            return false;
        job.server = block.server;
        block.ram -= job.ram;
        this.#totalRam -= job.ram;
        return true;
    }
    finish(job) {
        const block = this.getBlock(job.server);
        block.ram += job.ram;
        this.#totalRam += job.ram;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFtbmV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2dlbmVyYWwvcmFtbmV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFZMUQsTUFBTSxDQUFDLE9BQU8sT0FBTyxNQUFNO0lBQ3ZCLE9BQU8sR0FBWSxFQUFFLENBQUM7SUFDdEIsYUFBYSxHQUFHLFFBQVEsQ0FBQztJQUN6QixhQUFhLEdBQUcsQ0FBQyxDQUFDO0lBQ2xCLFNBQVMsR0FBRyxDQUFDLENBQUM7SUFDZCxPQUFPLEdBQUcsQ0FBQyxDQUFDO0lBQ1osTUFBTSxHQUF3QixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3hDLEdBQUcsQ0FBTztJQUVWLFlBQVksRUFBUztRQUNqQixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUk7UUFDTixLQUFLLE1BQU0sTUFBTSxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDekMsSUFBSSxNQUFNLElBQUksb0JBQW9CLEVBQUU7Z0JBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDakMsTUFBTSxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztpQkFDdEM7Z0JBQ0QsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDaEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ2hELE1BQU0sR0FBRyxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUN2RCxJQUFJLEdBQUcsSUFB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QUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9ELElBQUksQ0FBQyxLQUFLO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFDekIsR0FBRyxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQzFCLEtBQUssQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQztRQUNyQixJQUFJLENBQUMsU0FBUyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUM7UUFDMUIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxHQUFRO1FBQ1gsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEMsS0FBSyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxTQUFTLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQztJQUM5QixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbnMgZnJvbSBcIkBuc1wiO1xuaW1wb3J0IHsgbGlzdF9zZXJ2ZXJzLCBnYWluQWNjZXNzIH0gZnJvbSBcIi9nZW5lcmFsL3V0aWxzXCI7XG5cbmV4cG9ydCB0eXBlIEJsb2NrID0ge1xuICAgIHNlcnZlcjogc3RyaW5nO1xuICAgIHJhbTogbnVtYmVyO1xufVxuXG5leHBvcnQgdHlwZSBKb2IgPSB7XG4gICAgc2VydmVyOiBzdHJpbmc7XG4gICAgcmFtOiBudW1iZXI7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJhbU5ldCB7XG4gICAgI2Jsb2NrczogQmxvY2tbXSA9IFtdO1xuICAgICNtaW5CbG9ja1NpemUgPSBJbmZpbml0eTtcbiAgICAjbWF4QmxvY2tTaXplID0gMDtcbiAgICAjdG90YWxSYW0gPSAwO1xuICAgICNtYXhSYW0gPSAwO1xuICAgICNpbmRleDogTWFwPHN0cmluZywgbnVtYmVyPiA9IG5ldyBNYXAoKTtcbiAgICAjbnM6IG5zLk5TXG4gICAgXG4gICAgY29uc3RydWN0b3IobnM6IG5zLk5TKSB7XG4gICAgICAgIHRoaXMuI25zID0gbnM7XG4gICAgfVxuXG4gICAgYXN5bmMgaW5pdCgpIHtcbiAgICAgICAgZm9yIChjb25zdCBzZXJ2ZXIgb2YgbGlzdF9zZXJ2ZXJzKHRoaXMuI25zKSkge1xuICAgICAgICAgICAgaWYgKHNlcnZlciAhPSBcIkNvbnRyb2xsZXItQ2VudHJhbFwiKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLiNucy5oYXNSb290QWNjZXNzKHNlcnZlcikpIHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZ2FpbkFjY2Vzcyh0aGlzLiNucywgc2VydmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuI25zLmhhc1Jvb3RBY2Nlc3Moc2VydmVyKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXhSYW0gPSB0aGlzLiNucy5nZXRTZXJ2ZXJNYXhSYW0oc2VydmVyKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFtID0gbWF4UmFtIC0gdGhpcy4jbnMuZ2V0U2VydmVyVXNlZFJhbShzZXJ2ZXIpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmFtID49IDEuNjApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJsb2NrID0geyBzZXJ2ZXI6IHNlcnZlciwgcmFtOiByYW0gfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuI2Jsb2Nrcy5wdXNoKGJsb2NrKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyYW0gPCB0aGlzLiNtaW5CbG9ja1NpemUpIHRoaXMuI21pbkJsb2NrU2l6ZSA9IHJhbTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyYW0gPiB0aGlzLiNtYXhCbG9ja1NpemUpIHRoaXMuI21heEJsb2NrU2l6ZSA9IHJhbTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuI3RvdGFsUmFtICs9IHJhbTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuI21heFJhbSArPSBtYXhSYW07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblx0XHR0aGlzLiNzb3J0KCk7XG5cblx0XHR0aGlzLiNibG9ja3MuZm9yRWFjaCgoYmxvY2ssIGluZGV4KSA9PiB0aGlzLiNpbmRleC5zZXQoYmxvY2suc2VydmVyLCBpbmRleCkpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZSgpIHtcbiAgICAgICAgdGhpcy4jYmxvY2tzID0gW107XG4gICAgICAgIHRoaXMuI3RvdGFsUmFtICs9IDA7XG4gICAgICAgIHRoaXMuI21heFJhbSArPSAwO1xuICAgICAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiBsaXN0X3NlcnZlcnModGhpcy4jbnMpKSB7XG4gICAgICAgICAgICBpZiAoc2VydmVyICE9IFwiQ29udHJvbGxlci1DZW50cmFsXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuI25zLmhhc1Jvb3RBY2Nlc3Moc2VydmVyKSkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBnYWluQWNjZXNzKHRoaXMuI25zLCBzZXJ2ZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGhpcy4jbnMuaGFzUm9vdEFjY2VzcyhzZXJ2ZXIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1heFJhbSA9IHRoaXMuI25zLmdldFNlcnZlck1heFJhbShzZXJ2ZXIpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByYW0gPSBtYXhSYW0gLSB0aGlzLiNucy5nZXRTZXJ2ZXJVc2VkUmFtKHNlcnZlcik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyYW0gPj0gMS42MCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmxvY2sgPSB7IHNlcnZlcjogc2VydmVyLCByYW06IHJhbSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4jYmxvY2tzLnB1c2goYmxvY2spO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJhbSA8IHRoaXMuI21pbkJsb2NrU2l6ZSkgdGhpcy4jbWluQmxvY2tTaXplID0gcmFtO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJhbSA+IHRoaXMuI21heEJsb2NrU2l6ZSkgdGhpcy4jbWF4QmxvY2tTaXplID0gcmFtO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4jdG90YWxSYW0gKz0gcmFtO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4jbWF4UmFtICs9IG1heFJhbTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXHRcdHRoaXMuI3NvcnQoKTtcblxuXHRcdHRoaXMuI2Jsb2Nrcy5mb3JFYWNoKChibG9jaywgaW5kZXgpID0+IHRoaXMuI2luZGV4LnNldChibG9jay5zZXJ2ZXIsIGluZGV4KSk7XG4gICAgfVxuICAgIFxuXHQjc29ydCgpIHtcblx0XHR0aGlzLiNibG9ja3Muc29ydCgoeCwgeSkgPT4ge1xuXHRcdFx0Ly8gUHJlZmVyIGFzc2lnbmluZyB0byBob21lIGxhc3Qgc28gdGhhdCB3ZSBoYXZlIG1vcmUgcm9vbSB0byBwbGF5IHRoZSBnYW1lIHdoaWxlIGJhdGNoaW5nLlxuXHRcdFx0aWYgKHguc2VydmVyID09PSBcImhvbWVcIikgcmV0dXJuIDE7XG5cdFx0XHRpZiAoeS5zZXJ2ZXIgPT09IFwiaG9tZVwiKSByZXR1cm4gLTE7XG5cblx0XHRcdHJldHVybiB4LnJhbSAtIHkucmFtO1xuXHRcdH0pO1xuXHR9XG5cblx0Z2V0QmxvY2soc2VydmVyOiBzdHJpbmcpIHtcblx0XHRpZiAodGhpcy4jaW5kZXguaGFzKHNlcnZlcikpIHtcblx0XHRcdHJldHVybiB0aGlzLiNibG9ja3NbdGhpcy4jaW5kZXguZ2V0KHNlcnZlcikgYXMgbnVtYmVyXTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBTZXJ2ZXIgJHtzZXJ2ZXJ9IG5vdCBmb3VuZCBpbiBSYW1OZXQuYCk7XG5cdFx0fVxuXHR9XG5cbiAgICBoYXNCbG9jayhzZXJ2ZXI6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy4jaW5kZXguaGFzKHNlcnZlcik7XG4gICAgfVxuXHRnZXQgdG90YWxSYW0oKSB7XG5cdFx0cmV0dXJuIHRoaXMuI3RvdGFsUmFtO1xuXHR9XG5cblx0Z2V0IG1heFJhbSgpIHtcblx0XHRyZXR1cm4gdGhpcy4jbWF4UmFtO1xuXHR9XG5cblx0Z2V0IG1heEJsb2NrU2l6ZSgpIHtcblx0XHRyZXR1cm4gdGhpcy4jbWF4QmxvY2tTaXplO1xuXHR9XG5cblx0Z2V0IGNsb25lKCkge1xuXHRcdHJldHVybiB0aGlzLiNibG9ja3MubWFwKGJsb2NrID0+ICh7IC4uLmJsb2NrIH0pKTtcblx0fVxuXG4gICAgYXNzaWduKGpvYjogSm9iKSB7XG4gICAgICAgIGNvbnN0IGJsb2NrID0gdGhpcy4jYmxvY2tzLmZpbmQoYmxvY2sgPT4gYmxvY2sucmFtID49IGpvYi5yYW0pO1xuICAgICAgICBpZiAoIWJsb2NrKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGpvYi5zZXJ2ZXIgPSBibG9jay5zZXJ2ZXI7XG4gICAgICAgIGJsb2NrLnJhbSAtPSBqb2IucmFtO1xuICAgICAgICB0aGlzLiN0b3RhbFJhbSAtPSBqb2IucmFtO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBmaW5pc2goam9iOiBKb2IpIHtcbiAgICAgICAgY29uc3QgYmxvY2sgPSB0aGlzLmdldEJsb2NrKGpvYi5zZXJ2ZXIpO1xuICAgICAgICBibG9jay5yYW0gKz0gam9iLnJhbTtcbiAgICAgICAgdGhpcy4jdG90YWxSYW0gKz0gam9iLnJhbTtcbiAgICB9XG59Il19