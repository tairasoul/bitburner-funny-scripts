import { exploit } from "/rouletteburn-automated/game/get-game";
function extractNumberFromString(str) {
    const numericStr = str.replace(/\D/g, '');
    const number = parseInt(numericStr);
    return number;
}
function getGreenTile(table) {
    const rows = table.querySelectorAll("tr");
    const cells = [];
    rows.forEach(row => {
        const children = row.children;
        for (const child of children) {
            cells.push(child);
        }
    });
    for (const cell of cells) {
        if (cell.style.backgroundColor == "limegreen")
            return cell;
    }
    return null;
}
function getTile(num, table) {
    const rows = table.querySelectorAll('tr');
    for (const row of rows) {
        const cells = row.querySelectorAll('td');
        for (const cell of cells) {
            const buttons = cell.querySelectorAll('button');
            if (buttons.length > 0) {
                for (const button of buttons) {
                    if (button.textContent?.trim() === num.toString()) {
                        return button;
                    }
                }
            }
            else if (cell.textContent?.trim() === num.toString()) {
                return cell;
            }
        }
    }
    return null;
}
function clickBypassed(element) {
    const propsName = Object.keys(element).find((v) => v.startsWith("__reactProps$"));
    // @ts-ignore
    const click = element[propsName].onClick;
    const event = {
        target: element,
        currentTarget: element,
        bubbles: true,
        cancelable: true,
        type: 'click',
        isTrusted: true
    };
    // @ts-ignore
    click(event);
}
export async function cheat(ns) {
    ns.disableLog("sleep");
    const doc = eval("document");
    const pid = ns.run("rouletteburn.js");
    await ns.sleep(1500);
    const tailWindows = doc.querySelectorAll("div.react-resizable");
    let targetElement;
    tailWindows.forEach((window) => {
        const children = window.querySelectorAll(":scope > *");
        children.forEach((childElement) => {
            if (childElement.textContent?.trim().includes("rouletteburn.js")) {
                targetElement = window;
                return;
            }
        });
    });
    const divsWithRoleButton = doc.querySelectorAll('div[role="button"]');
    divsWithRoleButton.forEach(div => {
        if (Array.from(div.querySelectorAll('*')).some(element => element.textContent?.includes('City'))) {
            div.click();
        }
    });
    await ns.sleep(1000);
    const casino = doc.querySelector('span[aria-label="Iker Molina Casino"]');
    casino.click();
    await ns.sleep(1000);
    const playRoulette = doc.querySelector("#root > div.MuiBox-root > div.jss1.MuiBox-root > div > button:nth-child(3)");
    playRoulette.click();
    await ns.sleep(1000);
    if (targetElement) {
        while (true) {
            const game = await exploit();
            if (game.moneySourceA.casino > 10e9) {
                ns.kill(pid);
                divsWithRoleButton.forEach(div => {
                    if (Array.from(div.querySelectorAll('*')).some(element => element.textContent?.includes('Terminal'))) {
                        div.click();
                    }
                });
                break;
            }
            await ns.sleep(1);
            const rouletteBurn = targetElement.querySelector("table");
            const rouletteWindow = doc.querySelector("#root > div.MuiBox-root > div.MuiBox-root");
            const roulette = rouletteWindow?.querySelector("table");
            if (getGreenTile(rouletteBurn) == null) {
                const burnTile = getTile(1, rouletteBurn);
                if (burnTile)
                    burnTile.click();
                const rouletteTile = getTile(1, roulette);
                if (rouletteTile)
                    clickBypassed(rouletteTile);
                while (!rouletteWindow.querySelector(":nth-child(6)").textContent?.startsWith("playing"))
                    await ns.sleep(1);
                while (!rouletteWindow.querySelector(":nth-child(6)").textContent?.startsWith("lost ") && !rouletteWindow.querySelector(":nth-child(6)").textContent?.startsWith("won "))
                    await ns.sleep(1);
                const resultTile = rouletteWindow.querySelector(":nth-child(4)");
                if (resultTile) {
                    const tileNum = extractNumberFromString(resultTile.textContent);
                    const resultBurn = getTile(tileNum, rouletteBurn);
                    if (resultBurn)
                        resultBurn.click();
                }
            }
            else {
                const input = rouletteWindow.querySelector("div")?.querySelector("div")?.querySelector("input");
                const propsName = Object.keys(input).find((v) => v.startsWith("__reactProps$"));
                // @ts-ignore
                const props = input[propsName];
                props.onChange({ currentTarget: { value: 1e7 } });
                const burnTile = getGreenTile(rouletteBurn);
                const tile = parseInt(burnTile.textContent);
                const rouletteTile = getTile(tile, roulette);
                burnTile.click();
                if (rouletteTile)
                    clickBypassed(rouletteTile);
                while (!rouletteWindow.querySelector(":nth-child(6)").textContent?.startsWith("playing"))
                    await ns.sleep(1);
                while (!rouletteWindow.querySelector(":nth-child(6)").textContent?.startsWith("lost ") && !rouletteWindow.querySelector(":nth-child(6)").textContent?.startsWith("won "))
                    await ns.sleep(1);
                const resultTile = rouletteWindow.querySelector(":nth-child(4)");
                if (resultTile) {
                    const tileNum = extractNumberFromString(resultTile.textContent);
                    const resultBurn = getTile(tileNum, rouletteBurn);
                    if (resultBurn)
                        resultBurn.click();
                }
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtY2hlYXRpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcm91bGV0dGVidXJuLWF1dG9tYXRlZC9zdGFydC1jaGVhdGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFFaEUsU0FBUyx1QkFBdUIsQ0FBQyxHQUFXO0lBQ3hDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzFDLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNwQyxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsS0FBdUI7SUFDekMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFDLE1BQU0sS0FBSyxHQUFrQixFQUFFLENBQUM7SUFFaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNmLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7UUFDOUIsS0FBSyxNQUFNLEtBQUssSUFBSSxRQUFRLEVBQUU7WUFDMUIsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFvQixDQUFDLENBQUM7U0FDcEM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO1FBQ3RCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLElBQUksV0FBVztZQUN6QyxPQUFPLElBQUksQ0FBQztLQUNuQjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBQyxHQUFXLEVBQUUsS0FBdUI7SUFDakQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTFDLEtB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ZUFBZSxDQUFpQixDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBRSxjQUFjLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBaUIsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQztvQkFDdE0sTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUNyQixNQUFNLFVBQVUsR0FBRyxjQUFjLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUNqRSxJQUFJLFVBQVUsRUFBRTtvQkFDWixNQUFNLE9BQU8sR0FBRyx1QkFBdUIsQ0FBQyxVQUFVLENBQUMsV0FBcUIsQ0FBQyxDQUFDO29CQUMxRSxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUFDO29CQUNsRCxJQUFJLFVBQVU7d0JBQ1YsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO2lCQUMxQjthQUNKO1NBQ0o7S0FDSjtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbnMgZnJvbSBcIkBuc1wiO1xuaW1wb3J0IHsgZXhwbG9pdCB9IGZyb20gXCIvcm91bGV0dGVidXJuLWF1dG9tYXRlZC9nYW1lL2dldC1nYW1lXCI7XG5cbmZ1bmN0aW9uIGV4dHJhY3ROdW1iZXJGcm9tU3RyaW5nKHN0cjogc3RyaW5nKSB7XG4gICAgY29uc3QgbnVtZXJpY1N0ciA9IHN0ci5yZXBsYWNlKC9cXEQvZywgJycpO1xuICAgIGNvbnN0IG51bWJlciA9IHBhcnNlSW50KG51bWVyaWNTdHIpO1xuICAgIHJldHVybiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIGdldEdyZWVuVGlsZSh0YWJsZTogSFRNTFRhYmxlRWxlbWVudCkge1xuICAgIGNvbnN0IHJvd3MgPSB0YWJsZS5xdWVyeVNlbGVjdG9yQWxsKFwidHJcIik7XG4gICAgY29uc3QgY2VsbHM6IEhUTUxFbGVtZW50W10gPSBbXTtcbiAgICBcbiAgICByb3dzLmZvckVhY2gocm93ID0+IHtcbiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSByb3cuY2hpbGRyZW47XG4gICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGNlbGxzLnB1c2goY2hpbGQgYXMgSFRNTEVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgZm9yIChjb25zdCBjZWxsIG9mIGNlbGxzKSB7XG4gICAgICAgIGlmIChjZWxsLnN0eWxlLmJhY2tncm91bmRDb2xvciA9PSBcImxpbWVncmVlblwiKVxuICAgICAgICAgICAgcmV0dXJuIGNlbGw7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBnZXRUaWxlKG51bTogbnVtYmVyLCB0YWJsZTogSFRNTFRhYmxlRWxlbWVudCkge1xuICAgIGNvbnN0IHJvd3MgPSB0YWJsZS5xdWVyeVNlbGVjdG9yQWxsKCd0cicpO1xuXG4gICAgZm9yIChjb25zdCByb3cgb2Ygcm93cykge1xuICAgICAgICBjb25zdCBjZWxscyA9IHJvdy5xdWVyeVNlbGVjdG9yQWxsKCd0ZCcpO1xuXG4gICAgICAgIGZvciAoY29uc3QgY2VsbCBvZiBjZWxscykge1xuICAgICAgICAgICAgY29uc3QgYnV0dG9ucyA9IGNlbGwucXVlcnlTZWxlY3RvckFsbCgnYnV0dG9uJyk7XG5cbiAgICAgICAgICAgIGlmIChidXR0b25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGJ1dHRvbiBvZiBidXR0b25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChidXR0b24udGV4dENvbnRlbnQ/LnRyaW0oKSA9PT0gbnVtLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBidXR0b24gYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNlbGwudGV4dENvbnRlbnQ/LnRyaW0oKSA9PT0gbnVtLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2VsbCBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBjbGlja0J5cGFzc2VkKGVsZW1lbnQ6IEhUTUxFbGVtZW50KSB7XG4gICAgY29uc3QgcHJvcHNOYW1lID0gT2JqZWN0LmtleXMoZWxlbWVudCkuZmluZCgodikgPT4gdi5zdGFydHNXaXRoKFwiX19yZWFjdFByb3BzJFwiKSkgYXMgc3RyaW5nO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBjbGljayA9IGVsZW1lbnRbcHJvcHNOYW1lXS5vbkNsaWNrXG4gICAgY29uc3QgZXZlbnQgPSB7XG4gICAgICAgIHRhcmdldDogZWxlbWVudCxcbiAgICAgICAgY3VycmVudFRhcmdldDogZWxlbWVudCxcbiAgICAgICAgYnViYmxlczogdHJ1ZSxcbiAgICAgICAgY2FuY2VsYWJsZTogdHJ1ZSxcbiAgICAgICAgdHlwZTogJ2NsaWNrJyxcbiAgICAgICAgaXNUcnVzdGVkOiB0cnVlXG4gICAgfTtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY2xpY2soZXZlbnQpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2hlYXQobnM6IG5zLk5TKSB7XG4gICAgbnMuZGlzYWJsZUxvZyhcInNsZWVwXCIpO1xuICAgIGNvbnN0IGRvYyA9IGV2YWwoXCJkb2N1bWVudFwiKSBhcyBEb2N1bWVudDtcbiAgICBjb25zdCBwaWQgPSBucy5ydW4oXCJyb3VsZXR0ZWJ1cm4uanNcIilcbiAgICBhd2FpdCBucy5zbGVlcCgxNTAwKTtcbiAgICBjb25zdCB0YWlsV2luZG93cyA9IGRvYy5xdWVyeVNlbGVjdG9yQWxsKFwiZGl2LnJlYWN0LXJlc2l6YWJsZVwiKVxuICAgIGxldCB0YXJnZXRFbGVtZW50OiBIVE1MRWxlbWVudCB8IHVuZGVmaW5lZDtcbiAgICB0YWlsV2luZG93cy5mb3JFYWNoKCh3aW5kb3cpID0+IHtcbiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSB3aW5kb3cucXVlcnlTZWxlY3RvckFsbChcIjpzY29wZSA+ICpcIik7XG4gICAgICAgIGNoaWxkcmVuLmZvckVhY2goKGNoaWxkRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKGNoaWxkRWxlbWVudC50ZXh0Q29udGVudD8udHJpbSgpLmluY2x1ZGVzKFwicm91bGV0dGVidXJuLmpzXCIpKSB7XG4gICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudCA9IHdpbmRvdyBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZGl2c1dpdGhSb2xlQnV0dG9uID0gZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJ2Rpdltyb2xlPVwiYnV0dG9uXCJdJyk7XG5cbiAgICBkaXZzV2l0aFJvbGVCdXR0b24uZm9yRWFjaChkaXYgPT4ge1xuICAgICAgICBpZiAoQXJyYXkuZnJvbShkaXYucXVlcnlTZWxlY3RvckFsbCgnKicpKS5zb21lKGVsZW1lbnQgPT4gZWxlbWVudC50ZXh0Q29udGVudD8uaW5jbHVkZXMoJ0NpdHknKSkpIHtcbiAgICAgICAgICAgIChkaXYgYXMgSFRNTEVsZW1lbnQpLmNsaWNrKCk7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGF3YWl0IG5zLnNsZWVwKDEwMDApO1xuXG4gICAgY29uc3QgY2FzaW5vID0gZG9jLnF1ZXJ5U2VsZWN0b3IoJ3NwYW5bYXJpYS1sYWJlbD1cIklrZXIgTW9saW5hIENhc2lub1wiXScpIGFzIEhUTUxFbGVtZW50O1xuXG4gICAgY2FzaW5vLmNsaWNrKCk7XG5cbiAgICBhd2FpdCBucy5zbGVlcCgxMDAwKTtcblxuICAgIGNvbnN0IHBsYXlSb3VsZXR0ZSA9IGRvYy5xdWVyeVNlbGVjdG9yKFwiI3Jvb3QgPiBkaXYuTXVpQm94LXJvb3QgPiBkaXYuanNzMS5NdWlCb3gtcm9vdCA+IGRpdiA+IGJ1dHRvbjpudGgtY2hpbGQoMylcIikgYXMgSFRNTEVsZW1lbnQ7XG5cbiAgICBwbGF5Um91bGV0dGUuY2xpY2soKTtcblxuICAgIGF3YWl0IG5zLnNsZWVwKDEwMDApO1xuXG4gICAgaWYgKHRhcmdldEVsZW1lbnQpIHtcbiAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgIGNvbnN0IGdhbWUgPSBhd2FpdCBleHBsb2l0KCk7XG4gICAgICAgICAgICBpZiAoZ2FtZS5tb25leVNvdXJjZUEuY2FzaW5vID4gMTBlOSkge1xuICAgICAgICAgICAgICAgIG5zLmtpbGwocGlkKTtcblxuICAgICAgICAgICAgICAgIGRpdnNXaXRoUm9sZUJ1dHRvbi5mb3JFYWNoKGRpdiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5mcm9tKGRpdi5xdWVyeVNlbGVjdG9yQWxsKCcqJykpLnNvbWUoZWxlbWVudCA9PiBlbGVtZW50LnRleHRDb250ZW50Py5pbmNsdWRlcygnVGVybWluYWwnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIChkaXYgYXMgSFRNTEVsZW1lbnQpLmNsaWNrKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGF3YWl0IG5zLnNsZWVwKDEpO1xuICAgICAgICAgICAgY29uc3Qgcm91bGV0dGVCdXJuID0gdGFyZ2V0RWxlbWVudC5xdWVyeVNlbGVjdG9yKFwidGFibGVcIikgYXMgSFRNTFRhYmxlRWxlbWVudDtcbiAgICAgICAgICAgIGNvbnN0IHJvdWxldHRlV2luZG93ID0gZG9jLnF1ZXJ5U2VsZWN0b3IoXCIjcm9vdCA+IGRpdi5NdWlCb3gtcm9vdCA+IGRpdi5NdWlCb3gtcm9vdFwiKSBhcyBIVE1MRGl2RWxlbWVudDtcbiAgICAgICAgICAgIGNvbnN0IHJvdWxldHRlID0gcm91bGV0dGVXaW5kb3c/LnF1ZXJ5U2VsZWN0b3IoXCJ0YWJsZVwiKSBhcyBIVE1MVGFibGVFbGVtZW50O1xuICAgICAgICAgICAgaWYgKGdldEdyZWVuVGlsZShyb3VsZXR0ZUJ1cm4pID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBidXJuVGlsZSA9IGdldFRpbGUoMSwgcm91bGV0dGVCdXJuKTtcbiAgICAgICAgICAgICAgICBpZiAoYnVyblRpbGUpXG4gICAgICAgICAgICAgICAgICAgIGJ1cm5UaWxlLmNsaWNrKCk7XG4gICAgICAgICAgICAgICAgY29uc3Qgcm91bGV0dGVUaWxlID0gZ2V0VGlsZSgxLCByb3VsZXR0ZSk7XG4gICAgICAgICAgICAgICAgaWYgKHJvdWxldHRlVGlsZSlcbiAgICAgICAgICAgICAgICAgICAgY2xpY2tCeXBhc3NlZChyb3VsZXR0ZVRpbGUpO1xuICAgICAgICAgICAgICAgIHdoaWxlICghKHJvdWxldHRlV2luZG93LnF1ZXJ5U2VsZWN0b3IoXCI6bnRoLWNoaWxkKDYpXCIpIGFzIEhUTUxFbGVtZW50KS50ZXh0Q29udGVudD8uc3RhcnRzV2l0aChcInBsYXlpbmdcIikpXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IG5zLnNsZWVwKDEpXG4gICAgICAgICAgICAgICAgd2hpbGUgKCEocm91bGV0dGVXaW5kb3cucXVlcnlTZWxlY3RvcihcIjpudGgtY2hpbGQoNilcIikgYXMgSFRNTEVsZW1lbnQpLnRleHRDb250ZW50Py5zdGFydHNXaXRoKFwibG9zdCBcIikgJiYgIShyb3VsZXR0ZVdpbmRvdy5xdWVyeVNlbGVjdG9yKFwiOm50aC1jaGlsZCg2KVwiKSBhcyBIVE1MRWxlbWVudCkudGV4dENvbnRlbnQ/LnN0YXJ0c1dpdGgoXCJ3b24gXCIpKVxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBucy5zbGVlcCgxKVxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdFRpbGUgPSByb3VsZXR0ZVdpbmRvdy5xdWVyeVNlbGVjdG9yKFwiOm50aC1jaGlsZCg0KVwiKTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0VGlsZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0aWxlTnVtID0gZXh0cmFjdE51bWJlckZyb21TdHJpbmcocmVzdWx0VGlsZS50ZXh0Q29udGVudCBhcyBzdHJpbmcpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHRCdXJuID0gZ2V0VGlsZSh0aWxlTnVtLCByb3VsZXR0ZUJ1cm4pO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0QnVybilcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdEJ1cm4uY2xpY2soKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dCA9IHJvdWxldHRlV2luZG93LnF1ZXJ5U2VsZWN0b3IoXCJkaXZcIik/LnF1ZXJ5U2VsZWN0b3IoXCJkaXZcIik/LnF1ZXJ5U2VsZWN0b3IoXCJpbnB1dFwiKSBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9wc05hbWUgPSBPYmplY3Qua2V5cyhpbnB1dCkuZmluZCgodikgPT4gdi5zdGFydHNXaXRoKFwiX19yZWFjdFByb3BzJFwiKSkgYXMgc3RyaW5nO1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9wcyA9IGlucHV0W3Byb3BzTmFtZV1cbiAgICAgICAgICAgICAgICBwcm9wcy5vbkNoYW5nZSh7Y3VycmVudFRhcmdldDoge3ZhbHVlOiAxZTd9fSk7XG4gICAgICAgICAgICAgICAgY29uc3QgYnVyblRpbGUgPSBnZXRHcmVlblRpbGUocm91bGV0dGVCdXJuKSBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgICAgICBjb25zdCB0aWxlID0gcGFyc2VJbnQoYnVyblRpbGUudGV4dENvbnRlbnQgYXMgc3RyaW5nKTtcbiAgICAgICAgICAgICAgICBjb25zdCByb3VsZXR0ZVRpbGUgPSBnZXRUaWxlKHRpbGUsIHJvdWxldHRlKTtcbiAgICAgICAgICAgICAgICBidXJuVGlsZS5jbGljaygpO1xuICAgICAgICAgICAgICAgIGlmIChyb3VsZXR0ZVRpbGUpXG4gICAgICAgICAgICAgICAgICAgIGNsaWNrQnlwYXNzZWQocm91bGV0dGVUaWxlKTtcbiAgICAgICAgICAgICAgICB3aGlsZSAoIShyb3VsZXR0ZVdpbmRvdy5xdWVyeVNlbGVjdG9yKFwiOm50aC1jaGlsZCg2KVwiKSBhcyBIVE1MRWxlbWVudCkudGV4dENvbnRlbnQ/LnN0YXJ0c1dpdGgoXCJwbGF5aW5nXCIpKVxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBucy5zbGVlcCgxKVxuICAgICAgICAgICAgICAgIHdoaWxlICghKHJvdWxldHRlV2luZG93LnF1ZXJ5U2VsZWN0b3IoXCI6bnRoLWNoaWxkKDYpXCIpIGFzIEhUTUxFbGVtZW50KS50ZXh0Q29udGVudD8uc3RhcnRzV2l0aChcImxvc3QgXCIpICYmICEocm91bGV0dGVXaW5kb3cucXVlcnlTZWxlY3RvcihcIjpudGgtY2hpbGQoNilcIikgYXMgSFRNTEVsZW1lbnQpLnRleHRDb250ZW50Py5zdGFydHNXaXRoKFwid29uIFwiKSlcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAoMSlcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHRUaWxlID0gcm91bGV0dGVXaW5kb3cucXVlcnlTZWxlY3RvcihcIjpudGgtY2hpbGQoNClcIik7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdFRpbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGlsZU51bSA9IGV4dHJhY3ROdW1iZXJGcm9tU3RyaW5nKHJlc3VsdFRpbGUudGV4dENvbnRlbnQgYXMgc3RyaW5nKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0QnVybiA9IGdldFRpbGUodGlsZU51bSwgcm91bGV0dGVCdXJuKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdEJ1cm4pXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRCdXJuLmNsaWNrKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufSJdfQ==