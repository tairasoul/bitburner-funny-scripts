import Communicator from "/port-registry/classes/communicator";
export async function main(ns) {
    //ns.disableLog("ALL")
    const targetServer = ns.args[0];
    const commsPort = ns.args[1];
    const comms = ns.getPortHandle(commsPort);
    await comms.nextWrite();
    const controllerAmount = comms.peek();
    const portComms = new Communicator(ns);
    const ports = (await portComms.assignFirstAvailable(2));
    const serverData = ports.assignedPorts[0];
    const returnData = ports.assignedPorts[1];
    ns.atExit(() => {
        portComms.unassignPorts(ports.assignedPorts);
        ns.rm(`/lock/controllers/${targetServer}.txt`, "home");
    });
    const port = ns.getPortHandle(serverData);
    port.clear();
    port.write(targetServer);
    await ns.sleep(50);
    const returnPort = ns.getPortHandle(returnData);
    const grow = "/infect/worms/grow.js";
    const hack = "/infect/worms/hack.js";
    const weaken = "/infect/worms/weaken.js";
    ns.scp([grow, hack, weaken], "Controller-Worms", "home");
    const minMoney = ns.getServerMoneyAvailable(targetServer);
    while (true) {
        await ns.sleep(1);
        if (ns.getServerMoneyAvailable(targetServer) < minMoney) {
            while (true) {
                await deployScript(ns, grow, "Controller-Worms", controllerAmount, serverData, returnData);
                await returnPort.nextWrite();
                returnPort.clear();
                if (ns.getServerMoneyAvailable(targetServer) > minMoney * 2)
                    break;
            }
        }
        if (ns.getServerSecurityLevel(targetServer) > ns.getServerMinSecurityLevel(targetServer) * 1.5) {
            while (true) {
                await deployScript(ns, weaken, "Controller-Worms", controllerAmount, serverData, returnData);
                await returnPort.nextWrite();
                returnPort.clear();
                if (ns.getServerSecurityLevel(targetServer) <= ns.getServerMinSecurityLevel(targetServer))
                    break;
            }
        }
        while (true) {
            await deployScript(ns, hack, "Controller-Worms", controllerAmount, serverData, returnData);
            await returnPort.nextWrite();
            returnPort.clear();
            if (ns.getServerSecurityLevel(targetServer) > ns.getServerMinSecurityLevel(targetServer) * 1.5)
                break;
            if (ns.getServerMoneyAvailable(targetServer) < minMoney * 2)
                break;
        }
    }
}
async function deployScript(ns, script, server, controllers, ...args) {
    // this is probably not as efficient as it could be, it doesnt seem to use more than half of the memory on the server
    const scriptRam = ns.getScriptRam(script, "home");
    const available = ns.getServerMaxRam(server) / controllers - ns.getServerUsedRam(server) / controllers;
    const threads = Math.floor(available / scriptRam);
    ns.exec(script, server, threads, ...args);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmZlY3QvY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFlBQVksTUFBTSxxQ0FBcUMsQ0FBQztBQUUvRCxNQUFNLENBQUMsS0FBSyxVQUFVLElBQUksQ0FBQyxFQUFTO0lBQ2hDLHNCQUFzQjtJQUN0QixNQUFNLFlBQVksR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBVyxDQUFDO0lBQzFDLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFXLENBQUM7SUFDdkMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMxQyxNQUFNLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN4QixNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQVksQ0FBQztJQUNoRCxNQUFNLFNBQVMsR0FBRyxJQUFJLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2QyxNQUFNLEtBQUssR0FBRyxDQUFDLE1BQU0sU0FBUyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEQsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxQyxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFO1FBQ1gsU0FBUyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUE7UUFDNUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxxQkFBcUIsWUFBWSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDM0QsQ0FBQyxDQUFDLENBQUM7SUFDSCxNQUFNLElBQUksR0FBRyxFQUFFLENBQUMsYUFBYSxD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RyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEdBQUcsV0FBVyxDQUFDO0lBQ3ZHLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxDQUFDO0lBQ2xELEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztBQUM5QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG5zIGZyb20gXCJAbnNcIjtcbmltcG9ydCBDb21tdW5pY2F0b3IgZnJvbSBcIi9wb3J0LXJlZ2lzdHJ5L2NsYXNzZXMvY29tbXVuaWNhdG9yXCI7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYWluKG5zOiBucy5OUykge1xuICAgIC8vbnMuZGlzYWJsZUxvZyhcIkFMTFwiKVxuICAgIGNvbnN0IHRhcmdldFNlcnZlciA9IG5zLmFyZ3NbMF0gYXMgc3RyaW5nO1xuICAgIGNvbnN0IGNvbW1zUG9ydCA9IG5zLmFyZ3NbMV0gYXMgbnVtYmVyO1xuICAgIGNvbnN0IGNvbW1zID0gbnMuZ2V0UG9ydEhhbmRsZShjb21tc1BvcnQpO1xuICAgIGF3YWl0IGNvbW1zLm5leHRXcml0ZSgpO1xuICAgIGNvbnN0IGNvbnRyb2xsZXJBbW91bnQgPSBjb21tcy5wZWVrKCkgYXMgbnVtYmVyO1xuICAgIGNvbnN0IHBvcnRDb21tcyA9IG5ldyBDb21tdW5pY2F0b3IobnMpO1xuICAgIGNvbnN0IHBvcnRzID0gKGF3YWl0IHBvcnRDb21tcy5hc3NpZ25GaXJzdEF2YWlsYWJsZSgyKSk7XG4gICAgY29uc3Qgc2VydmVyRGF0YSA9IHBvcnRzLmFzc2lnbmVkUG9ydHNbMF07XG4gICAgY29uc3QgcmV0dXJuRGF0YSA9IHBvcnRzLmFzc2lnbmVkUG9ydHNbMV07XG4gICAgbnMuYXRFeGl0KCgpID0+IHtcbiAgICAgICAgcG9ydENvbW1zLnVuYXNzaWduUG9ydHMocG9ydHMuYXNzaWduZWRQb3J0cylcbiAgICAgICAgbnMucm0oYC9sb2NrL2NvbnRyb2xsZXJzLyR7dGFyZ2V0U2VydmVyfS50eHRgLCBcImhvbWVcIik7XG4gICAgfSk7XG4gICAgY29uc3QgcG9ydCA9IG5zLmdldFBvcnRIYW5kbGUoc2VydmVyRGF0YSk7XG4gICAgcG9ydC5jbGVhcigpO1xuICAgIHBvcnQud3JpdGUodGFyZ2V0U2VydmVyKVxuICAgIGF3YWl0IG5zLnNsZWVwKDUwKTtcbiAgICBjb25zdCByZXR1cm5Qb3J0ID0gbnMuZ2V0UG9ydEhhbmRsZShyZXR1cm5EYXRhKTtcbiAgICBjb25zdCBncm93ID0gXCIvaW5mZWN0L3dvcm1zL2dyb3cuanNcIjtcbiAgICBjb25zdCBoYWNrID0gXCIvaW5mZWN0L3dvcm1zL2hhY2suanNcIjtcbiAgICBjb25zdCB3ZWFrZW4gPSBcIi9pbmZlY3Qvd29ybXMvd2Vha2VuLmpzXCI7XG4gICAgbnMuc2NwKFtncm93LCBoYWNrLCB3ZWFrZW5dLCBcIkNvbnRyb2xsZXItV29ybXNcIiwgXCJob21lXCIpXG4gICAgY29uc3QgbWluTW9uZXkgPSBucy5nZXRTZXJ2ZXJNb25leUF2YWlsYWJsZSh0YXJnZXRTZXJ2ZXIpO1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgIGF3YWl0IG5zLnNsZWVwKDEpO1xuICAgICAgICBpZiAobnMuZ2V0U2VydmVyTW9uZXlBdmFpbGFibGUodGFyZ2V0U2VydmVyKSA8IG1pbk1vbmV5KSB7XG4gICAgICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IGRlcGxveVNjcmlwdChucywgZ3JvdywgXCJDb250cm9sbGVyLVdvcm1zXCIsIGNvbnRyb2xsZXJBbW91bnQsIHNlcnZlckRhdGEsIHJldHVybkRhdGEpO1xuICAgICAgICAgICAgICAgIGF3YWl0IHJldHVyblBvcnQubmV4dFdyaXRlKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuUG9ydC5jbGVhcigpO1xuICAgICAgICAgICAgICAgIGlmIChucy5nZXRTZXJ2ZXJNb25leUF2YWlsYWJsZSh0YXJnZXRTZXJ2ZXIpID4gbWluTW9uZXkgKiAyKVxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAobnMuZ2V0U2VydmVyU2VjdXJpdHlMZXZlbCh0YXJnZXRTZXJ2ZXIpID4gbnMuZ2V0U2VydmVyTWluU2VjdXJpdHlMZXZlbCh0YXJnZXRTZXJ2ZXIpICogMS41KSB7XG4gICAgICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IGRlcGxveVNjcmlwdChucywgd2Vha2VuLCBcIkNvbnRyb2xsZXItV29ybXNcIiwgY29udHJvbGxlckFtb3VudCwgc2VydmVyRGF0YSwgcmV0dXJuRGF0YSk7XG4gICAgICAgICAgICAgICAgYXdhaXQgcmV0dXJuUG9ydC5uZXh0V3JpdGUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm5Qb3J0LmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgaWYgKG5zLmdldFNlcnZlclNlY3VyaXR5TGV2ZWwodGFyZ2V0U2VydmVyKSA8PSBucy5nZXRTZXJ2ZXJNaW5TZWN1cml0eUxldmVsKHRhcmdldFNlcnZlcikpXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBhd2FpdCBkZXBsb3lTY3JpcHQobnMsIGhhY2ssIFwiQ29udHJvbGxlci1Xb3Jtc1wiLCBjb250cm9sbGVyQW1vdW50LCBzZXJ2ZXJEYXRhLCByZXR1cm5EYXRhKTtcbiAgICAgICAgICAgIGF3YWl0IHJldHVyblBvcnQubmV4dFdyaXRlKCk7XG4gICAgICAgICAgICByZXR1cm5Qb3J0LmNsZWFyKCk7XG4gICAgICAgICAgICBpZiAobnMuZ2V0U2VydmVyU2VjdXJpdHlMZXZlbCh0YXJnZXRTZXJ2ZXIpID4gbnMuZ2V0U2VydmVyTWluU2VjdXJpdHlMZXZlbCh0YXJnZXRTZXJ2ZXIpICogMS41KVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgaWYgKG5zLmdldFNlcnZlck1vbmV5QXZhaWxhYmxlKHRhcmdldFNlcnZlcikgPCBtaW5Nb25leSAqIDIpXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlcGxveVNjcmlwdChuczogbnMuTlMsIHNjcmlwdDogc3RyaW5nLCBzZXJ2ZXI6IHN0cmluZywgY29udHJvbGxlcnM6IG51bWJlciwgLi4uYXJnczogYW55W10pIHtcbiAgICAvLyB0aGlzIGlzIHByb2JhYmx5IG5vdCBhcyBlZmZpY2llbnQgYXMgaXQgY291bGQgYmUsIGl0IGRvZXNudCBzZWVtIHRvIHVzZSBtb3JlIHRoYW4gaGFsZiBvZiB0aGUgbWVtb3J5IG9uIHRoZSBzZXJ2ZXJcbiAgICBjb25zdCBzY3JpcHRSYW0gPSBucy5nZXRTY3JpcHRSYW0oc2NyaXB0LCBcImhvbWVcIik7XG4gICAgY29uc3QgYXZhaWxhYmxlID0gbnMuZ2V0U2VydmVyTWF4UmFtKHNlcnZlcikgLyBjb250cm9sbGVycyAtIG5zLmdldFNlcnZlclVzZWRSYW0oc2VydmVyKSAvIGNvbnRyb2xsZXJzO1xuICAgIGNvbnN0IHRocmVhZHMgPSBNYXRoLmZsb29yKGF2YWlsYWJsZSAvIHNjcmlwdFJhbSk7XG4gICAgbnMuZXhlYyhzY3JpcHQsIHNlcnZlciwgdGhyZWFkcywgLi4uYXJncyk7XG59Il19