import Communicator from "/service-communicators/port-registry";
import RamnetComms from "/service-communicators/ramnet";
import Multiport from "/general/multiport";
export async function main(ns) {
    //ns.disableLog("ALL")
    ns.disableLog("sleep");
    ns.disableLog("exec");
    ns.disableLog("getScriptRam");
    ns.disableLog("scp");
    const targetServer = ns.args[0];
    const commsPort = ns.args[1];
    const ramnet = new RamnetComms(ns);
    ns.print(`getting ramnet's total ram`);
    const ramnetRam = await ramnet.getTotalRam();
    ns.print(`got ramnet ram, ${ramnetRam.totalRam}`);
    const comms = ns.getPortHandle(commsPort);
    ns.print(`awaiting ${commsPort} nextWrite();`);
    await comms.nextWrite();
    const controllerAmount = comms.peek();
    ns.print(`got controller amount, ${controllerAmount}`);
    const ramnetDedicated = Math.floor(ramnetRam.totalRam / controllerAmount);
    ns.print(`ram on ramnet dedicated per controller: ${ramnetDedicated}`);
    const portComms = new Communicator(ns);
    const ports = (await portComms.assignFirstAvailable(1));
    const returnPorts = await portComms.assignFirstAvailable(1000);
    const startSignal = ports.assignedPorts[0];
    ns.atExit(() => {
        portComms.unassignPorts(ports.assignedPorts);
        portComms.unassignPorts(returnPorts.assignedPorts);
        ns.rm(`/lock/controllers/${targetServer}.txt`, "home");
    });
    const returnPort = new Multiport(ns, { ports: returnPorts.assignedPorts });
    await ns.sleep(50);
    const growS = "/infect/worms/grow.js";
    const hackS = "/infect/worms/hack.js";
    const weakenS = "/infect/worms/weaken.js";
    let ramUsed = 0;
    const jobs = {
        grow: {
            ram: ns.getScriptRam(growS, "home"),
            server: ""
        },
        weaken: {
            ram: ns.getScriptRam(weakenS, "home"),
            server: ""
        },
        hack: {
            ram: ns.getScriptRam(hackS, "home"),
            server: ""
        }
    };
    const start = ns.getPortHandle(startSignal);
    const minMoney = ns.getServerMaxMoney(targetServer) * 0.5;
    while (true) {
        await ns.sleep(1);
        if (ns.getServerMoneyAvailable(targetServer) < minMoney) {
            while (true) {
                await ns.sleep(1);
                const jobsAssigned = [];
                while (true) {
                    const newJob = await ramnet.assignJob(jobs.grow);
                    const server = newJob.jobAssigned.server;
                    const serverRam = ns.getServerMaxRam(server) - ns.getServerUsedRam(server);
                    let threads = Math.floor(serverRam / ns.getScriptRam(growS, "home"));
                    let ramUsage = ns.getScriptRam(growS, "home") * threads;
                    if (ramUsed + ramUsage >= ramnetDedicated) {
                        while (ramUsed + ramUsage >= ramnetDedicated) {
                            if (threads == 0)
                                break;
                            threads -= 1;
                            ramUsage = ns.getScriptRam(growS, "home") * threads;
                        }
                    }
                    ramUsed += ramUsage;
                    await ramnet.finishJob(newJob.jobAssigned);
                    ns.print(`ram used: ${ramUsed}/${ramnetDedicated}`);
                    if (ramUsed >= ramnetDedicated || threads == 0) {
                        ramUsed -= ramUsage;
                        break;
                    }
                    const realJob = await ramnet.assignJob({ ram: ramUsage, server: "" });
                    jobsAssigned.push(realJob.jobAssigned);
                    ensureScriptExistence(ns, realJob.jobAssigned.server);
                    ns.tprint(threads);
                    grow(ns, threads, realJob.jobAssigned.server, returnPorts.assignedPorts, { server: targetServer, startPort: startSignal });
                }
                let jobsFinished = 0;
                ns.print(`making sure all scripts can get start signal..`);
                await ns.sleep(1000);
                ns.print(`starting all scripts.`);
                start.write("GO");
                while (true) {
                    await ns.sleep(1);
                    if (!returnPort.empty()) {
                        returnPort.read();
                        jobsFinished++;
                    }
                    if (jobsFinished == jobsAssigned.length - 1) {
                        ns.print(`telling ramnet the jobs are finished (${jobsFinished} jobs)`);
                        for (const job of jobsAssigned) {
                            await ramnet.finishJob(job);
                        }
                        break;
                    }
                }
                if (ns.getServerMoneyAvailable(targetServer) > minMoney * 2)
                    break;
            }
        }
        if (ns.getServerSecurityLevel(targetServer) > ns.getServerMinSecurityLevel(targetServer) * 1.5) {
            while (true) {
                await ns.sleep(1);
                const jobsAssigned = [];
                while (true) {
                    const newJob = await ramnet.assignJob(jobs.grow);
                    const server = newJob.jobAssigned.server;
                    const serverRam = ns.getServerMaxRam(server) - ns.getServerUsedRam(server);
                    let threads = Math.floor(serverRam / ns.getScriptRam(weakenS, "home"));
                    let ramUsage = ns.getScriptRam(weakenS, "home") * threads;
                    if (ramUsed + ramUsage >= ramnetDedicated) {
                        while (ramUsed + ramUsage >= ramnetDedicated) {
                            if (threads == 0)
                                break;
                            threads -= 1;
                            ramUsage = ns.getScriptRam(growS, "home") * threads;
                        }
                    }
                    ramUsed += ramUsage;
                    await ramnet.finishJob(newJob.jobAssigned);
                    ns.print(`ram used: ${ramUsed}/${ramnetDedicated}`);
                    if (ramUsed >= ramnetDedicated || threads == 0) {
                        ramUsed -= ramUsage;
                        break;
                    }
                    const realJob = await ramnet.assignJob({ ram: ramUsage, server: "" });
                    jobsAssigned.push(realJob.jobAssigned);
                    ensureScriptExistence(ns, realJob.jobAssigned.server);
                    ns.tprint(threads);
                    weaken(ns, threads, realJob.jobAssigned.server, returnPorts.assignedPorts, { server: targetServer, startPort: startSignal });
                }
                let jobsFinished = 0;
                ns.print(`making sure all scripts can get start signal..`);
                await ns.sleep(1000);
                ns.print(`starting all scripts.`);
                start.write("GO");
                while (true) {
                    await ns.sleep(1);
                    if (!returnPort.empty()) {
                        returnPort.read();
                        jobsFinished++;
                    }
                    if (jobsFinished == jobsAssigned.length - 1) {
                        ns.print(`telling ramnet the jobs are finished (${jobsFinished} jobs)`);
                        for (const job of jobsAssigned) {
                            await ramnet.finishJob(job);
                        }
                        break;
                    }
                }
                if (ns.getServerSecurityLevel(targetServer) <= ns.getServerMinSecurityLevel(targetServer))
                    break;
            }
        }
        while (true) {
            await ns.sleep(1);
            const jobsAssigned = [];
            while (true) {
                const newJob = await ramnet.assignJob(jobs.grow);
                const server = newJob.jobAssigned.server;
                const serverRam = ns.getServerMaxRam(server) - ns.getServerUsedRam(server);
                let threads = Math.floor(serverRam / ns.getScriptRam(hackS, "home"));
                let ramUsage = ns.getScriptRam(hackS, "home") * threads;
                if (ramUsed + ramUsage >= ramnetDedicated) {
                    while (ramUsed + ramUsage >= ramnetDedicated) {
                        if (threads == 0)
                            break;
                        threads -= 1;
                        ramUsage = ns.getScriptRam(growS, "home") * threads;
                    }
                }
                ramUsed += ramUsage;
                await ramnet.finishJob(newJob.jobAssigned);
                ns.print(`ram used: ${ramUsed}/${ramnetDedicated}`);
                if (ramUsed >= ramnetDedicated || threads == 0) {
                    ramUsed -= ramUsage;
                    break;
                }
                const realJob = await ramnet.assignJob({ ram: ramUsage, server: "" });
                jobsAssigned.push(realJob.jobAssigned);
                ensureScriptExistence(ns, realJob.jobAssigned.server);
                ns.tprint(threads);
                hack(ns, threads, realJob.jobAssigned.server, returnPorts.assignedPorts, { server: targetServer, startPort: startSignal });
            }
            let jobsFinished = 0;
            ns.print(`making sure all scripts can get start signal..`);
            await ns.sleep(1000);
            ns.print(`starting all scripts.`);
            start.write("GO");
            while (true) {
                await ns.sleep(1);
                if (!returnPort.empty()) {
                    returnPort.read();
                    jobsFinished++;
                }
                if (jobsFinished == jobsAssigned.length - 1) {
                    ns.print(`telling ramnet the jobs are finished (${jobsFinished} jobs)`);
                    for (const job of jobsAssigned) {
                        await ramnet.finishJob(job);
                    }
                    break;
                }
            }
            if (ns.getServerSecurityLevel(targetServer) > ns.getServerMinSecurityLevel(targetServer) * 1.5)
                break;
            if (ns.getServerMoneyAvailable(targetServer) < minMoney * 2)
                break;
        }
    }
}
function grow(ns, threads, deploymentServer, returnData, data) {
    deployScript(ns, threads, "/infect/worms/grow.js", deploymentServer, JSON.stringify(returnData), JSON.stringify(data));
}
function weaken(ns, threads, deploymentServer, returnData, data) {
    deployScript(ns, threads, "/infect/worms/weaken.js", deploymentServer, JSON.stringify(returnData), JSON.stringify(data));
}
function hack(ns, threads, deploymentServer, returnData, data) {
    deployScript(ns, threads, "/infect/worms/hack.js", deploymentServer, JSON.stringify(returnData), JSON.stringify(data));
}
function deployScript(ns, threads, script, server, ...args) {
    ns.exec(script, server, { threads, temporary: true }, ...args);
}
function ensureScriptExistence(ns, server) {
    if (!ns.fileExists("/infect/worms/grow.js", server))
        ns.scp("/infect/worms/grow.js", server, "home");
    if (!ns.fileExists("/infect/worms/hack.js", server))
        ns.scp("/infect/worms/hack.js", server, "home");
    if (!ns.fileExists("/infect/worms/weaken.js", server))
        ns.scp("/infect/worms/weaken.js", server, "home");
    if (!ns.fileExists("/general/multiport.js", server))
        ns.scp("/general/multiport.js", server, "home");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmZlY3QvY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFlBQVksTUFBTSxzQ0FBc0MsQ0FBQztBQUNoRSxPQUFPLFdBQVcsTUFBTSwrQkFBK0IsQ0FBQztBQUd4RCxPQUFPLFNBQVMsTUFBTSxvQkFBb0IsQ0FBQztBQUUzQyxNQUFNLENBQUMsS0FBSyxVQUFVLElBQUksQ0FBQyxFQUFTO0lBQ2hDLHNCQUFzQjtJQUN0QixFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZCLEVBQUUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEIsRUFBRSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUM5QixFQUFFLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JCLE1BQU0sWUFBWSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFXLENBQUM7SUFDMUMsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQVcsQ0FBQztJQUN2QyxNQUFNLE1BQU0sR0FBRyxJQUFJLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNuQyxFQUFFLENBQUMsS0FBSyxDQUFDLDRCQUE0QixDQUFDLENBQUM7SUFDdkMsTUFBTSxTQUFTLEdBQUcsTUFBTSxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDN0MsRUFBRSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDbEQsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMxQyxFQUFFLENBQUMsS0FBSyxDQUFDLFlBQVksU0FBUyxlQUFlLENBQUMsQ0FBQTtJQUM5QyxNQUFNLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztJ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VUFBVSxDQUFDLHVCQUF1QixFQUFFLE1BQU0sQ0FBQztRQUMvQyxFQUFFLENBQUMsR0FBRyxDQUFDLHVCQUF1QixFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNwRCxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyx5QkFBeUIsRUFBRSxNQUFNLENBQUM7UUFDakQsRUFBRSxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsdUJBQXVCLEVBQUUsTUFBTSxDQUFDO1FBQy9DLEVBQUUsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ3hELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbnMgZnJvbSBcIkBuc1wiO1xuaW1wb3J0IENvbW11bmljYXRvciBmcm9tIFwiL3NlcnZpY2UtY29tbXVuaWNhdG9ycy9wb3J0LXJlZ2lzdHJ5XCI7XG5pbXBvcnQgUmFtbmV0Q29tbXMgZnJvbSBcIi9zZXJ2aWNlLWNvbW11bmljYXRvcnMvcmFtbmV0XCI7XG5pbXBvcnQgeyBKb2IgfSBmcm9tIFwiL2dlbmVyYWwvcmFtbmV0XCI7XG5pbXBvcnQgeyBXb3JtRGF0YSB9IGZyb20gXCIuL3dvcm1zL3R5cGVzXCI7XG5pbXBvcnQgTXVsdGlwb3J0IGZyb20gXCIvZ2VuZXJhbC9tdWx0aXBvcnRcIjtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1haW4obnM6IG5zLk5TKSB7XG4gICAgLy9ucy5kaXNhYmxlTG9nKFwiQUxMXCIpXG4gICAgbnMuZGlzYWJsZUxvZyhcInNsZWVwXCIpO1xuICAgIG5zLmRpc2FibGVMb2coXCJleGVjXCIpO1xuICAgIG5zLmRpc2FibGVMb2coXCJnZXRTY3JpcHRSYW1cIik7XG4gICAgbnMuZGlzYWJsZUxvZyhcInNjcFwiKTtcbiAgICBjb25zdCB0YXJnZXRTZXJ2ZXIgPSBucy5hcmdzWzBdIGFzIHN0cmluZztcbiAgICBjb25zdCBjb21tc1BvcnQgPSBucy5hcmdzWzFdIGFzIG51bWJlcjtcbiAgICBjb25zdCByYW1uZXQgPSBuZXcgUmFtbmV0Q29tbXMobnMpO1xuICAgIG5zLnByaW50KGBnZXR0aW5nIHJhbW5ldCdzIHRvdGFsIHJhbWApO1xuICAgIGNvbnN0IHJhbW5ldFJhbSA9IGF3YWl0IHJhbW5ldC5nZXRUb3RhbFJhbSgpO1xuICAgIG5zLnByaW50KGBnb3QgcmFtbmV0IHJhbSwgJHtyYW1uZXRSYW0udG90YWxSYW19YCk7XG4gICAgY29uc3QgY29tbXMgPSBucy5nZXRQb3J0SGFuZGxlKGNvbW1zUG9ydCk7XG4gICAgbnMucHJpbnQoYGF3YWl0aW5nICR7Y29tbXNQb3J0fSBuZXh0V3JpdGUoKTtgKVxuICAgIGF3YWl0IGNvbW1zLm5leHRXcml0ZSgpO1xuICAgIGNvbnN0IGNvbnRyb2xsZXJBbW91bnQgPSBjb21tcy5wZWVrKCkgYXMgbnVtYmVyO1xuICAgIG5zLnByaW50KGBnb3QgY29udHJvbGxlciBhbW91bnQsICR7Y29udHJvbGxlckFtb3VudH1gKTtcbiAgICBjb25zdCByYW1uZXREZWRpY2F0ZWQgPSBNYXRoLmZsb29yKHJhbW5ldFJhbS50b3RhbFJhbSAvIGNvbnRyb2xsZXJBbW91bnQpO1xuICAgIG5zLnByaW50KGByYW0gb24gcmFtbmV0IGRlZGljYXRlZCBwZXIgY29udHJvbGxlcjogJHtyYW1uZXREZWRpY2F0ZWR9YCk7XG4gICAgY29uc3QgcG9ydENvbW1zID0gbmV3IENvbW11bmljYXRvcihucyk7XG4gICAgY29uc3QgcG9ydHMgPSAoYXdhaXQgcG9ydENvbW1zLmFzc2lnbkZpcnN0QXZhaWxhYmxlKDEpKTtcbiAgICBjb25zdCByZXR1cm5Qb3J0cyA9IGF3YWl0IHBvcnRDb21tcy5hc3NpZ25GaXJzdEF2YWlsYWJsZSgxMDAwKTtcbiAgICBjb25zdCBzdGFydFNpZ25hbCA9IHBvcnRzLmFzc2lnbmVkUG9ydHNbMF07XG4gICAgbnMuYXRFeGl0KCgpID0+IHtcbiAgICAgICAgcG9ydENvbW1zLnVuYXNzaWduUG9ydHMocG9ydHMuYXNzaWduZWRQb3J0cylcbiAgICAgICAgcG9ydENvbW1zLnVuYXNzaWduUG9ydHMocmV0dXJuUG9ydHMuYXNzaWduZWRQb3J0cyk7XG4gICAgICAgIG5zLnJtKGAvbG9jay9jb250cm9sbGVycy8ke3RhcmdldFNlcnZlcn0udHh0YCwgXCJob21lXCIpO1xuICAgIH0pO1xuICAgIGNvbnN0IHJldHVyblBvcnQgPSBuZXcgTXVsdGlwb3J0KG5zLCB7cG9ydHM6IHJldHVyblBvcnRzLmFzc2lnbmVkUG9ydHN9KVxuICAgIGF3YWl0IG5zLnNsZWVwKDUwKTtcbiAgICBjb25zdCBncm93UyA9IFwiL2luZmVjdC93b3Jtcy9ncm93LmpzXCI7XG4gICAgY29uc3QgaGFja1MgPSBcIi9pbmZlY3Qvd29ybXMvaGFjay5qc1wiO1xuICAgIGNvbnN0IHdlYWtlblMgPSBcIi9pbmZlY3Qvd29ybXMvd2Vha2VuLmpzXCI7XG4gICAgbGV0IHJhbVVzZWQgPSAwO1xuICAgIGNvbnN0IGpvYnMgPSB7XG4gICAgICAgIGdyb3c6IHtcbiAgICAgICAgICAgIHJhbTogbnMuZ2V0U2NyaXB0UmFtKGdyb3dTLCBcImhvbWVcIiksXG4gICAgICAgICAgICBzZXJ2ZXI6IFwiXCJcbiAgICAgICAgfSxcbiAgICAgICAgd2Vha2VuOiB7XG4gICAgICAgICAgICByYW06IG5zLmdldFNjcmlwdFJhbSh3ZWFrZW5TLCBcImhvbWVcIiksXG4gICAgICAgICAgICBzZXJ2ZXI6IFwiXCJcbiAgICAgICAgfSxcbiAgICAgICAgaGFjazoge1xuICAgICAgICAgICAgcmFtOiBucy5nZXRTY3JpcHRSYW0oaGFja1MsIFwiaG9tZVwiKSxcbiAgICAgICAgICAgIHNlcnZlcjogXCJcIlxuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHN0YXJ0ID0gbnMuZ2V0UG9ydEhhbmRsZShzdGFydFNpZ25hbCk7XG4gICAgY29uc3QgbWluTW9uZXkgPSBucy5nZXRTZXJ2ZXJNYXhNb25leSh0YXJnZXRTZXJ2ZXIpICogMC41O1xuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgIGF3YWl0IG5zLnNsZWVwKDEpO1xuICAgICAgICBpZiAobnMuZ2V0U2VydmVyTW9uZXlBdmFpbGFibGUodGFyZ2V0U2VydmVyKSA8IG1pbk1vbmV5KSB7XG4gICAgICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IG5zLnNsZWVwKDEpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGpvYnNBc3NpZ25lZDogSm9iW10gPSBbXTtcbiAgICAgICAgICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdKb2IgPSBhd2FpdCByYW1uZXQuYXNzaWduSm9iKGpvYnMuZ3Jvdyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlcnZlciA9IG5ld0pvYi5qb2JBc3NpZ25lZC5zZXJ2ZXI7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlcnZlclJhbSA9IG5zLmdldFNlcnZlck1heFJhbShzZXJ2ZXIpIC0gbnMuZ2V0U2VydmVyVXNlZFJhbShzZXJ2ZXIpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgdGhyZWFkcyA9IE1hdGguZmxvb3Ioc2VydmVyUmFtIC8gbnMuZ2V0U2NyaXB0UmFtKGdyb3dTLCBcImhvbWVcIikpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmFtVXNhZ2UgPSBucy5nZXRTY3JpcHRSYW0oZ3Jvd1MsIFwiaG9tZVwiKSAqIHRocmVhZHM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyYW1Vc2VkICsgcmFtVXNhZ2UgPj0gcmFtbmV0RGVkaWNhdGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAocmFtVXNlZCArIHJhbVVzYWdlID49IHJhbW5ldERlZGljYXRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aHJlYWRzID09IDApIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZHMgLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW1Vc2FnZSA9IG5zLmdldFNjcmlwdFJhbShncm93UywgXCJob21lXCIpICogdGhyZWFkcztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByYW1Vc2VkICs9IHJhbVVzYWdlO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCByYW1uZXQuZmluaXNoSm9iKG5ld0pvYi5qb2JBc3NpZ25lZCk7XG4gICAgICAgICAgICAgICAgICAgIG5zLnByaW50KGByYW0gdXNlZDogJHtyYW1Vc2VkfS8ke3JhbW5ldERlZGljYXRlZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbVVzZWQgPj0gcmFtbmV0RGVkaWNhdGVkIHx8IHRocmVhZHMgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmFtVXNlZCAtPSByYW1Vc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWxKb2IgPSBhd2FpdCByYW1uZXQuYXNzaWduSm9iKHtyYW06IHJhbVVzYWdlLCBzZXJ2ZXI6IFwiXCJ9KTtcbiAgICAgICAgICAgICAgICAgICAgam9ic0Fzc2lnbmVkLnB1c2gocmVhbEpvYi5qb2JBc3NpZ25lZClcbiAgICAgICAgICAgICAgICAgICAgZW5zdXJlU2NyaXB0RXhpc3RlbmNlKG5zLCByZWFsSm9iLmpvYkFzc2lnbmVkLnNlcnZlcik7XG4gICAgICAgICAgICAgICAgICAgIG5zLnRwcmludCh0aHJlYWRzKTtcbiAgICAgICAgICAgICAgICAgICAgZ3JvdyhucywgdGhyZWFkcywgcmVhbEpvYi5qb2JBc3NpZ25lZC5zZXJ2ZXIsIHJldHVyblBvcnRzLmFzc2lnbmVkUG9ydHMsIHtzZXJ2ZXI6IHRhcmdldFNlcnZlciwgc3RhcnRQb3J0OiBzdGFydFNpZ25hbH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsZXQgam9ic0ZpbmlzaGVkID0gMDtcbiAgICAgICAgICAgICAgICBucy5wcmludChgbWFraW5nIHN1cmUgYWxsIHNjcmlwdHMgY2FuIGdldCBzdGFydCBzaWduYWwuLmApO1xuICAgICAgICAgICAgICAgIGF3YWl0IG5zLnNsZWVwKDEwMDApO1xuICAgICAgICAgICAgICAgIG5zLnByaW50KGBzdGFydGluZyBhbGwgc2NyaXB0cy5gKTtcbiAgICAgICAgICAgICAgICBzdGFydC53cml0ZShcIkdPXCIpO1xuICAgICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IG5zLnNsZWVwKDEpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXJldHVyblBvcnQuZW1wdHkoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuUG9ydC5yZWFkKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBqb2JzRmluaXNoZWQrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoam9ic0ZpbmlzaGVkID09IGpvYnNBc3NpZ25lZC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBucy5wcmludChgdGVsbGluZyByYW1uZXQgdGhlIGpvYnMgYXJlIGZpbmlzaGVkICgke2pvYnNGaW5pc2hlZH0gam9icylgKVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBqb2Igb2Ygam9ic0Fzc2lnbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmFtbmV0LmZpbmlzaEpvYihqb2IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG5zLmdldFNlcnZlck1vbmV5QXZhaWxhYmxlKHRhcmdldFNlcnZlcikgPiBtaW5Nb25leSAqIDIpXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChucy5nZXRTZXJ2ZXJTZWN1cml0eUxldmVsKHRhcmdldFNlcnZlcikgPiBucy5nZXRTZXJ2ZXJNaW5TZWN1cml0eUxldmVsKHRhcmdldFNlcnZlcikgKiAxLjUpIHtcbiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAoMSk7XG4gICAgICAgICAgICAgICAgY29uc3Qgam9ic0Fzc2lnbmVkOiBKb2JbXSA9IFtdO1xuICAgICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0pvYiA9IGF3YWl0IHJhbW5ldC5hc3NpZ25Kb2Ioam9icy5ncm93KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VydmVyID0gbmV3Sm9iLmpvYkFzc2lnbmVkLnNlcnZlcjtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VydmVyUmFtID0gbnMuZ2V0U2VydmVyTWF4UmFtKHNlcnZlcikgLSBucy5nZXRTZXJ2ZXJVc2VkUmFtKHNlcnZlcik7XG4gICAgICAgICAgICAgICAgICAgIGxldCB0aHJlYWRzID0gTWF0aC5mbG9vcihzZXJ2ZXJSYW0gLyBucy5nZXRTY3JpcHRSYW0od2Vha2VuUywgXCJob21lXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJhbVVzYWdlID0gbnMuZ2V0U2NyaXB0UmFtKHdlYWtlblMsIFwiaG9tZVwiKSAqIHRocmVhZHM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyYW1Vc2VkICsgcmFtVXNhZ2UgPj0gcmFtbmV0RGVkaWNhdGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAocmFtVXNlZCArIHJhbVVzYWdlID49IHJhbW5ldERlZGljYXRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aHJlYWRzID09IDApIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZHMgLT0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW1Vc2FnZSA9IG5zLmdldFNjcmlwdFJhbShncm93UywgXCJob21lXCIpICogdGhyZWFkcztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByYW1Vc2VkICs9IHJhbVVzYWdlO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCByYW1uZXQuZmluaXNoSm9iKG5ld0pvYi5qb2JBc3NpZ25lZCk7XG4gICAgICAgICAgICAgICAgICAgIG5zLnByaW50KGByYW0gdXNlZDogJHtyYW1Vc2VkfS8ke3JhbW5ldERlZGljYXRlZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbVVzZWQgPj0gcmFtbmV0RGVkaWNhdGVkIHx8IHRocmVhZHMgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmFtVXNlZCAtPSByYW1Vc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWxKb2IgPSBhd2FpdCByYW1uZXQuYXNzaWduSm9iKHtyYW06IHJhbVVzYWdlLCBzZXJ2ZXI6IFwiXCJ9KTtcbiAgICAgICAgICAgICAgICAgICAgam9ic0Fzc2lnbmVkLnB1c2gocmVhbEpvYi5qb2JBc3NpZ25lZClcbiAgICAgICAgICAgICAgICAgICAgZW5zdXJlU2NyaXB0RXhpc3RlbmNlKG5zLCByZWFsSm9iLmpvYkFzc2lnbmVkLnNlcnZlcik7XG4gICAgICAgICAgICAgICAgICAgIG5zLnRwcmludCh0aHJlYWRzKTtcbiAgICAgICAgICAgICAgICAgICAgd2Vha2VuKG5zLCB0aHJlYWRzLCByZWFsSm9iLmpvYkFzc2lnbmVkLnNlcnZlciwgcmV0dXJuUG9ydHMuYXNzaWduZWRQb3J0cywge3NlcnZlcjogdGFyZ2V0U2VydmVyLCBzdGFydFBvcnQ6IHN0YXJ0U2lnbmFsfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBqb2JzRmluaXNoZWQgPSAwO1xuICAgICAgICAgICAgICAgIG5zLnByaW50KGBtYWtpbmcgc3VyZSBhbGwgc2NyaXB0cyBjYW4gZ2V0IHN0YXJ0IHNpZ25hbC4uYCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAoMTAwMCk7XG4gICAgICAgICAgICAgICAgbnMucHJpbnQoYHN0YXJ0aW5nIGFsbCBzY3JpcHRzLmApO1xuICAgICAgICAgICAgICAgIHN0YXJ0LndyaXRlKFwiR09cIik7XG4gICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAoMSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcmV0dXJuUG9ydC5lbXB0eSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5Qb3J0LnJlYWQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGpvYnNGaW5pc2hlZCsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChqb2JzRmluaXNoZWQgPT0gam9ic0Fzc2lnbmVkLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5zLnByaW50KGB0ZWxsaW5nIHJhbW5ldCB0aGUgam9icyBhcmUgZmluaXNoZWQgKCR7am9ic0ZpbmlzaGVkfSBqb2JzKWApXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGpvYiBvZiBqb2JzQXNzaWduZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCByYW1uZXQuZmluaXNoSm9iKGpvYik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobnMuZ2V0U2VydmVyU2VjdXJpdHlMZXZlbCh0YXJnZXRTZXJ2ZXIpIDw9IG5zLmdldFNlcnZlck1pblNlY3VyaXR5TGV2ZWwodGFyZ2V0U2VydmVyKSlcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgIGF3YWl0IG5zLnNsZWVwKDEpO1xuICAgICAgICAgICAgY29uc3Qgam9ic0Fzc2lnbmVkOiBKb2JbXSA9IFtdO1xuICAgICAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdKb2IgPSBhd2FpdCByYW1uZXQuYXNzaWduSm9iKGpvYnMuZ3Jvdyk7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VydmVyID0gbmV3Sm9iLmpvYkFzc2lnbmVkLnNlcnZlcjtcbiAgICAgICAgICAgICAgICBjb25zdCBzZXJ2ZXJSYW0gPSBucy5nZXRTZXJ2ZXJNYXhSYW0oc2VydmVyKSAtIG5zLmdldFNlcnZlclVzZWRSYW0oc2VydmVyKTtcbiAgICAgICAgICAgICAgICBsZXQgdGhyZWFkcyA9IE1hdGguZmxvb3Ioc2VydmVyUmFtIC8gbnMuZ2V0U2NyaXB0UmFtKGhhY2tTLCBcImhvbWVcIikpO1xuICAgICAgICAgICAgICAgIGxldCByYW1Vc2FnZSA9IG5zLmdldFNjcmlwdFJhbShoYWNrUywgXCJob21lXCIpICogdGhyZWFkcztcbiAgICAgICAgICAgICAgICBpZiAocmFtVXNlZCArIHJhbVVzYWdlID49IHJhbW5ldERlZGljYXRlZCkge1xuICAgICAgICAgICAgICAgICAgICB3aGlsZSAocmFtVXNlZCArIHJhbVVzYWdlID49IHJhbW5ldERlZGljYXRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRocmVhZHMgPT0gMCkgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJlYWRzIC09IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICByYW1Vc2FnZSA9IG5zLmdldFNjcmlwdFJhbShncm93UywgXCJob21lXCIpICogdGhyZWFkcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByYW1Vc2VkICs9IHJhbVVzYWdlO1xuICAgICAgICAgICAgICAgIGF3YWl0IHJhbW5ldC5maW5pc2hKb2IobmV3Sm9iLmpvYkFzc2lnbmVkKTtcbiAgICAgICAgICAgICAgICBucy5wcmludChgcmFtIHVzZWQ6ICR7cmFtVXNlZH0vJHtyYW1uZXREZWRpY2F0ZWR9YCk7XG4gICAgICAgICAgICAgICAgaWYgKHJhbVVzZWQgPj0gcmFtbmV0RGVkaWNhdGVkIHx8IHRocmVhZHMgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByYW1Vc2VkIC09IHJhbVVzYWdlO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgcmVhbEpvYiA9IGF3YWl0IHJhbW5ldC5hc3NpZ25Kb2Ioe3JhbTogcmFtVXNhZ2UsIHNlcnZlcjogXCJcIn0pO1xuICAgICAgICAgICAgICAgIGpvYnNBc3NpZ25lZC5wdXNoKHJlYWxKb2Iuam9iQXNzaWduZWQpXG4gICAgICAgICAgICAgICAgZW5zdXJlU2NyaXB0RXhpc3RlbmNlKG5zLCByZWFsSm9iLmpvYkFzc2lnbmVkLnNlcnZlcik7XG4gICAgICAgICAgICAgICAgbnMudHByaW50KHRocmVhZHMpO1xuICAgICAgICAgICAgICAgIGhhY2sobnMsIHRocmVhZHMsIHJlYWxKb2Iuam9iQXNzaWduZWQuc2VydmVyLCByZXR1cm5Qb3J0cy5hc3NpZ25lZFBvcnRzLCB7c2VydmVyOiB0YXJnZXRTZXJ2ZXIsIHN0YXJ0UG9ydDogc3RhcnRTaWduYWx9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBqb2JzRmluaXNoZWQgPSAwO1xuICAgICAgICAgICAgbnMucHJpbnQoYG1ha2luZyBzdXJlIGFsbCBzY3JpcHRzIGNhbiBnZXQgc3RhcnQgc2lnbmFsLi5gKTtcbiAgICAgICAgICAgIGF3YWl0IG5zLnNsZWVwKDEwMDApO1xuICAgICAgICAgICAgbnMucHJpbnQoYHN0YXJ0aW5nIGFsbCBzY3JpcHRzLmApO1xuICAgICAgICAgICAgc3RhcnQud3JpdGUoXCJHT1wiKTtcbiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgbnMuc2xlZXAoMSk7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXR1cm5Qb3J0LmVtcHR5KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuUG9ydC5yZWFkKCk7XG4gICAgICAgICAgICAgICAgICAgIGpvYnNGaW5pc2hlZCsrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoam9ic0ZpbmlzaGVkID09IGpvYnNBc3NpZ25lZC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIG5zLnByaW50KGB0ZWxsaW5nIHJhbW5ldCB0aGUgam9icyBhcmUgZmluaXNoZWQgKCR7am9ic0ZpbmlzaGVkfSBqb2JzKWApXG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgam9iIG9mIGpvYnNBc3NpZ25lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmFtbmV0LmZpbmlzaEpvYihqb2IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChucy5nZXRTZXJ2ZXJTZWN1cml0eUxldmVsKHRhcmdldFNlcnZlcikgPiBucy5nZXRTZXJ2ZXJNaW5TZWN1cml0eUxldmVsKHRhcmdldFNlcnZlcikgKiAxLjUpXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBpZiAobnMuZ2V0U2VydmVyTW9uZXlBdmFpbGFibGUodGFyZ2V0U2VydmVyKSA8IG1pbk1vbmV5ICogMilcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gZ3JvdyhuczogbnMuTlMsIHRocmVhZHM6IG51bWJlciwgZGVwbG95bWVudFNlcnZlcjogc3RyaW5nLCByZXR1cm5EYXRhOiBudW1iZXJbXSwgZGF0YTogV29ybURhdGEpIHtcbiAgICBkZXBsb3lTY3JpcHQobnMsIHRocmVhZHMsIFwiL2luZmVjdC93b3Jtcy9ncm93LmpzXCIsIGRlcGxveW1lbnRTZXJ2ZXIsIEpTT04uc3RyaW5naWZ5KHJldHVybkRhdGEpLCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XG59XG5cbmZ1bmN0aW9uIHdlYWtlbihuczogbnMuTlMsIHRocmVhZHM6IG51bWJlciwgZGVwbG95bWVudFNlcnZlcjogc3RyaW5nLCByZXR1cm5EYXRhOiBudW1iZXJbXSwgZGF0YTogV29ybURhdGEpIHtcbiAgICBkZXBsb3lTY3JpcHQobnMsIHRocmVhZHMsIFwiL2luZmVjdC93b3Jtcy93ZWFrZW4uanNcIiwgZGVwbG95bWVudFNlcnZlciwgSlNPTi5zdHJpbmdpZnkocmV0dXJuRGF0YSksIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbn1cblxuZnVuY3Rpb24gaGFjayhuczogbnMuTlMsIHRocmVhZHM6IG51bWJlciwgZGVwbG95bWVudFNlcnZlcjogc3RyaW5nLCByZXR1cm5EYXRhOiBudW1iZXJbXSwgZGF0YTogV29ybURhdGEpIHtcbiAgICBkZXBsb3lTY3JpcHQobnMsIHRocmVhZHMsIFwiL2luZmVjdC93b3Jtcy9oYWNrLmpzXCIsIGRlcGxveW1lbnRTZXJ2ZXIsIEpTT04uc3RyaW5naWZ5KHJldHVybkRhdGEpLCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XG59XG5cbmZ1bmN0aW9uIGRlcGxveVNjcmlwdChuczogbnMuTlMsIHRocmVhZHM6IG51bWJlciwgc2NyaXB0OiBzdHJpbmcsIHNlcnZlcjogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkge1xuICAgIG5zLmV4ZWMoc2NyaXB0LCBzZXJ2ZXIsIHt0aHJlYWRzLCB0ZW1wb3Jhcnk6IHRydWV9LCAuLi5hcmdzKTtcbn1cblxuZnVuY3Rpb24gZW5zdXJlU2NyaXB0RXhpc3RlbmNlKG5zOiBucy5OUywgc2VydmVyOiBzdHJpbmcpIHtcbiAgICBpZiAoIW5zLmZpbGVFeGlzdHMoXCIvaW5mZWN0L3dvcm1zL2dyb3cuanNcIiwgc2VydmVyKSlcbiAgICAgICAgbnMuc2NwKFwiL2luZmVjdC93b3Jtcy9ncm93LmpzXCIsIHNlcnZlciwgXCJob21lXCIpO1xuICAgIGlmICghbnMuZmlsZUV4aXN0cyhcIi9pbmZlY3Qvd29ybXMvaGFjay5qc1wiLCBzZXJ2ZXIpKVxuICAgICAgICBucy5zY3AoXCIvaW5mZWN0L3dvcm1zL2hhY2suanNcIiwgc2VydmVyLCBcImhvbWVcIik7XG4gICAgaWYgKCFucy5maWxlRXhpc3RzKFwiL2luZmVjdC93b3Jtcy93ZWFrZW4uanNcIiwgc2VydmVyKSlcbiAgICAgICAgbnMuc2NwKFwiL2luZmVjdC93b3Jtcy93ZWFrZW4uanNcIiwgc2VydmVyLCBcImhvbWVcIik7XG4gICAgaWYgKCFucy5maWxlRXhpc3RzKFwiL2dlbmVyYWwvbXVsdGlwb3J0LmpzXCIsIHNlcnZlcikpXG4gICAgICAgIG5zLnNjcChcIi9nZW5lcmFsL211bHRpcG9ydC5qc1wiLCBzZXJ2ZXIsIFwiaG9tZVwiKTtcbn0iXX0=