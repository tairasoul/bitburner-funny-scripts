import { mapServers, gainAccess } from "/infect/utils.js";
import Communicator from "/service-communicators/port-registry";
let pids = 0;
let minMoneyCap = 0;
export async function main(ns) {
    const flags = ns.flags([["runhome", false], ["moneyCap", 150000000], ["deployServer", "Controller-Central"]]);
    const allowRunOnHome = flags.runhome;
    const deployServer = flags.deployServer;
    minMoneyCap = flags.moneyCap;
    ns.rm("controller-data/controllers.txt", deployServer);
    pids = 0;
    const comms = new Communicator(ns);
    const mapped = await mapServers(ns);
    const infectedServers = new Set();
    const portsAssigned = await comms.assignFirstAvailable(1);
    const start = portsAssigned.assignedPorts[0];
    for (const server of mapped) {
        await infectServer(ns, server.name, infectedServers, start, deployServer, allowRunOnHome);
        await processServers(ns, server, infectedServers, start, deployServer, allowRunOnHome);
    }
    const elements = [];
    for (const value of infectedServers.values())
        elements.push(value);
    ns.toast(`hacked ${pids} servers!`, "info", 3000);
    ns.toast("completed processing of server list", "success", 2000);
    const portComms = ns.getPortHandle(start);
    await ns.sleep(2500);
    portComms.write(pids);
    await ns.sleep(20000);
    comms.unassignPorts([start]);
}
async function processServers(ns, map, infectedSet, commsStart, deployServer, allowRunOnHome) {
    for (const mapped of map.sub_servers) {
        await infectServer(ns, mapped.name, infectedSet, commsStart, deployServer, allowRunOnHome);
        await processServers(ns, mapped, infectedSet, commsStart, deployServer, allowRunOnHome);
    }
}
async function infectServer(ns, server, infectedSet, commsStart, deployServer, allowRunOnHome) {
    const script = "/infect/controller.js";
    const canHack = ns.getPlayer().skills.hacking >= ns.getServerRequiredHackingLevel(server);
    if (canHack) {
        const result = await gainAccess(ns, server);
        if (result.nuke) {
            const maxMoney = ns.getServerMaxMoney(server);
            if (maxMoney >= minMoneyCap) {
                if (deployServer != "home") {
                    ns.scp([script, "/general/multiport.js", "/service-communicators/port-registry.js", "/general/remote-file.js", "/service-communicators/ramnet.js", "/general/logs.js"], "Controller-Central", "home");
                    ns.exec(script, deployServer, undefined, server, commsStart, allowRunOnHome);
                }
                else
                    ns.run(script, undefined, server, commsStart, allowRunOnHome);
                pids += 1;
            }
            infectedSet.add(server);
        }
        else {
            ns.tprint(`could not gain access to ${server}`);
        }
    }
    else {
        ns.tprint(`cannot hack server ${server}, hacking skill ${ns.getPlayer().skills.hacking} is lower than required hacking skill ${ns.getServerRequiredHackingLevel(server)}!`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mZWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2luZmVjdC9pbmZlY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQWMsTUFBTSxrQkFBa0IsQ0FBQztBQUV0RSxPQUFPLFlBQVksTUFBTSxzQ0FBc0MsQ0FBQztBQUVoRSxJQUFJLElBQUksR0FBRyxDQUFDLENBQUM7QUFFYixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFFcEIsTUFBTSxDQUFDLEtBQUssVUFBVSxJQUFJLENBQUMsRUFBUztJQUNoQyxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUcsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDLE9BQWtCLENBQUM7SUFDaEQsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFlBQXNCLENBQUM7SUFDbEQsV0FBVyxHQUFHLEtBQUssQ0FBQyxRQUFrQixDQUFDO0lBQ3ZDLEVBQUUsQ0FBQyxFQUFFLENBQUMsaUNBQWlDLEVBQUUsWUFBWSxDQUFDLENBQUE7SUFDdEQsSUFBSSxHQUFHLENBQUMsQ0FBQztJQUNULE1BQU0sS0FBSyxHQUFHLElBQUksWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sZUFBZSxHQUFnQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQy9DLE1BQU0sYUFBYSxHQUFHLE1BQU0sS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzFELE1BQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxD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RUFBRSxVQUFVLEVBQUUsY0FBYyxDQUFDLENBQUE7Z0JBQ2xFLElBQUksSUFBSSxDQUFDLENBQUM7YUFDYjtZQUNELFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDM0I7YUFDSTtZQUNELEVBQUUsQ0FBQyxNQUFNLENBQUMsNEJBQTRCLE1BQU0sRUFBRSxDQUFDLENBQUM7U0FDbkQ7S0FDSjtTQUNJO1FBQ0QsRUFBRSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsTUFBTSxtQkFBbUIsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLHlDQUF5QyxFQUFFLENBQUMsNkJBQTZCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQy9LO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1hcFNlcnZlcnMsIGdhaW5BY2Nlc3MsIFNlcnZlckluZm8gfSBmcm9tIFwiL2luZmVjdC91dGlscy5qc1wiO1xuaW1wb3J0IG5zIGZyb20gXCJAbnNcIjtcbmltcG9ydCBDb21tdW5pY2F0b3IgZnJvbSBcIi9zZXJ2aWNlLWNvbW11bmljYXRvcnMvcG9ydC1yZWdpc3RyeVwiO1xuXG5sZXQgcGlkcyA9IDA7XG5cbmxldCBtaW5Nb25leUNhcCA9IDA7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYWluKG5zOiBucy5OUykge1xuICAgIGNvbnN0IGZsYWdzID0gbnMuZmxhZ3MoW1tcInJ1bmhvbWVcIiwgZmFsc2VdLCBbXCJtb25leUNhcFwiLCAxNTAwMDAwMDBdLCBbXCJkZXBsb3lTZXJ2ZXJcIiwgXCJDb250cm9sbGVyLUNlbnRyYWxcIl1dKTtcbiAgICBjb25zdCBhbGxvd1J1bk9uSG9tZSA9IGZsYWdzLnJ1bmhvbWUgYXMgYm9vbGVhbjtcbiAgICBjb25zdCBkZXBsb3lTZXJ2ZXIgPSBmbGFncy5kZXBsb3lTZXJ2ZXIgYXMgc3RyaW5nO1xuICAgIG1pbk1vbmV5Q2FwID0gZmxhZ3MubW9uZXlDYXAgYXMgbnVtYmVyO1xuICAgIG5zLnJtKFwiY29udHJvbGxlci1kYXRhL2NvbnRyb2xsZXJzLnR4dFwiLCBkZXBsb3lTZXJ2ZXIpXG4gICAgcGlkcyA9IDA7XG4gICAgY29uc3QgY29tbXMgPSBuZXcgQ29tbXVuaWNhdG9yKG5zKTtcbiAgICBjb25zdCBtYXBwZWQgPSBhd2FpdCBtYXBTZXJ2ZXJzKG5zKTtcbiAgICBjb25zdCBpbmZlY3RlZFNlcnZlcnM6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpO1xuICAgIGNvbnN0IHBvcnRzQXNzaWduZWQgPSBhd2FpdCBjb21tcy5hc3NpZ25GaXJzdEF2YWlsYWJsZSgxKTtcbiAgICBjb25zdCBzdGFydCA9IHBvcnRzQXNzaWduZWQuYXNzaWduZWRQb3J0c1swXTtcbiAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiBtYXBwZWQpIHtcbiAgICAgICAgYXdhaXQgaW5mZWN0U2VydmVyKG5zLCBzZXJ2ZXIubmFtZSwgaW5mZWN0ZWRTZXJ2ZXJzLCBzdGFydCwgZGVwbG95U2VydmVyLCBhbGxvd1J1bk9uSG9tZSk7XG4gICAgICAgIGF3YWl0IHByb2Nlc3NTZXJ2ZXJzKG5zLCBzZXJ2ZXIsIGluZmVjdGVkU2VydmVycywgc3RhcnQsIGRlcGxveVNlcnZlciwgYWxsb3dSdW5PbkhvbWUpO1xuICAgIH1cbiAgICBjb25zdCBlbGVtZW50cyA9IFtdO1xuICAgIGZvciAoY29uc3QgdmFsdWUgb2YgaW5mZWN0ZWRTZXJ2ZXJzLnZhbHVlcygpKVxuICAgICAgICBlbGVtZW50cy5wdXNoKHZhbHVlKTtcbiAgICBucy50b2FzdChgaGFja2VkICR7cGlkc30gc2VydmVycyFgLCBcImluZm9cIiwgMzAwMClcbiAgICBucy50b2FzdChcImNvbXBsZXRlZCBwcm9jZXNzaW5nIG9mIHNlcnZlciBsaXN0XCIsIFwic3VjY2Vzc1wiLCAyMDAwKTtcbiAgICBjb25zdCBwb3J0Q29tbXMgPSBucy5nZXRQb3J0SGFuZGxlKHN0YXJ0KVxuICAgIGF3YWl0IG5zLnNsZWVwKDI1MDApO1xuICAgIHBvcnRDb21tcy53cml0ZShwaWRzKTtcbiAgICBhd2FpdCBucy5zbGVlcCgyMDAwMCk7XG4gICAgY29tbXMudW5hc3NpZ25Qb3J0cyhbc3RhcnRdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc1NlcnZlcnMobnM6IG5zLk5TLCBtYXA6IFNlcnZlckluZm8sIGluZmVjdGVkU2V0OiBTZXQ8c3RyaW5nPiwgY29tbXNTdGFydDogbnVtYmVyLCBkZXBsb3lTZXJ2ZXI6IHN0cmluZywgYWxsb3dSdW5PbkhvbWU6IGJvb2xlYW4pIHtcbiAgICBmb3IgKGNvbnN0IG1hcHBlZCBvZiBtYXAuc3ViX3NlcnZlcnMpIHtcbiAgICAgICAgYXdhaXQgaW5mZWN0U2VydmVyKG5zLCBtYXBwZWQubmFtZSwgaW5mZWN0ZWRTZXQsIGNvbW1zU3RhcnQsIGRlcGxveVNlcnZlciwgYWxsb3dSdW5PbkhvbWUpO1xuICAgICAgICBhd2FpdCBwcm9jZXNzU2VydmVycyhucywgbWFwcGVkLCBpbmZlY3RlZFNldCwgY29tbXNTdGFydCwgZGVwbG95U2VydmVyLCBhbGxvd1J1bk9uSG9tZSk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbmZlY3RTZXJ2ZXIobnM6IG5zLk5TLCBzZXJ2ZXI6IHN0cmluZywgaW5mZWN0ZWRTZXQ6IFNldDxzdHJpbmc+LCBjb21tc1N0YXJ0OiBudW1iZXIsIGRlcGxveVNlcnZlcjogc3RyaW5nLCBhbGxvd1J1bk9uSG9tZTogYm9vbGVhbikge1xuICAgIGNvbnN0IHNjcmlwdCA9IFwiL2luZmVjdC9jb250cm9sbGVyLmpzXCI7XG4gICAgY29uc3QgY2FuSGFjayA9IG5zLmdldFBsYXllcigpLnNraWxscy5oYWNraW5nID49IG5zLmdldFNlcnZlclJlcXVpcmVkSGFja2luZ0xldmVsKHNlcnZlcik7XG4gICAgaWYgKGNhbkhhY2spIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2FpbkFjY2Vzcyhucywgc2VydmVyKTtcbiAgICAgICAgaWYgKHJlc3VsdC5udWtlKSB7XG4gICAgICAgICAgICBjb25zdCBtYXhNb25leSA9IG5zLmdldFNlcnZlck1heE1vbmV5KHNlcnZlcilcbiAgICAgICAgICAgIGlmIChtYXhNb25leSA+PSBtaW5Nb25leUNhcCkge1xuICAgICAgICAgICAgICAgIGlmIChkZXBsb3lTZXJ2ZXIgIT0gXCJob21lXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgbnMuc2NwKFtzY3JpcHQsIFwiL2dlbmVyYWwvbXVsdGlwb3J0LmpzXCIsIFwiL3NlcnZpY2UtY29tbXVuaWNhdG9ycy9wb3J0LXJlZ2lzdHJ5LmpzXCIsIFwiL2dlbmVyYWwvcmVtb3RlLWZpbGUuanNcIiwgXCIvc2VydmljZS1jb21tdW5pY2F0b3JzL3JhbW5ldC5qc1wiLCBcIi9nZW5lcmFsL2xvZ3MuanNcIl0sIFwiQ29udHJvbGxlci1DZW50cmFsXCIsIFwiaG9tZVwiKVxuICAgICAgICAgICAgICAgICAgICBucy5leGVjKHNjcmlwdCwgZGVwbG95U2VydmVyLCB1bmRlZmluZWQsIHNlcnZlciwgY29tbXNTdGFydCwgYWxsb3dSdW5PbkhvbWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIG5zLnJ1bihzY3JpcHQsIHVuZGVmaW5lZCwgc2VydmVyLCBjb21tc1N0YXJ0LCBhbGxvd1J1bk9uSG9tZSlcbiAgICAgICAgICAgICAgICBwaWRzICs9IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbmZlY3RlZFNldC5hZGQoc2VydmVyKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG5zLnRwcmludChgY291bGQgbm90IGdhaW4gYWNjZXNzIHRvICR7c2VydmVyfWApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBucy50cHJpbnQoYGNhbm5vdCBoYWNrIHNlcnZlciAke3NlcnZlcn0sIGhhY2tpbmcgc2tpbGwgJHtucy5nZXRQbGF5ZXIoKS5za2lsbHMuaGFja2luZ30gaXMgbG93ZXIgdGhhbiByZXF1aXJlZCBoYWNraW5nIHNraWxsICR7bnMuZ2V0U2VydmVyUmVxdWlyZWRIYWNraW5nTGV2ZWwoc2VydmVyKX0hYCk7XG4gICAgfVxufSJdfQ==